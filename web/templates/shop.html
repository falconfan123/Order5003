<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>饭团外卖 - 商家工作台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Element Plus -->
  <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
  <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
  <script src="https://unpkg.com/@element-plus/icons-vue"></script>
  <!-- 字体 -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-color: #00cbd3;
      --primary-dark: #00b5bc;
      --bg-color: #f7f8fa;
      --text-main: #333333;
      --text-sub: #999999;
      --border-color: #eeeeee;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Noto Sans SC', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
    }

    #app {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* 登录遮罩 */
    .login-mask {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .login-card {
      background: #fff;
      padding: 32px 28px 26px;
      border-radius: 20px;
      width: 360px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.2);
      text-align: center;
    }

    .brand-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .brand-icon {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
    }

    .brand-text {
      font-size: 22px;
      font-weight: 900;
    }

    /* 顶部栏 */
    .shop-header {
      height: 64px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      z-index: 10;
    }

    .shop-header-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .shop-logo {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
    }

    .shop-info-main {
      display: flex;
      flex-direction: column;
    }

    .shop-name {
      font-size: 18px;
      font-weight: 900;
    }

    .shop-sub {
      font-size: 12px;
      color: var(--text-sub);
    }

    .shop-header-right {
      display: flex;
      align-items: center;
      gap: 18px;
      font-size: 13px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    /* 主布局 */
    .layout-main {
      flex: 1;
      display: flex;
      min-height: 0;
    }

    .side-nav {
      width: 220px;
      background: #fff;
      border-right: 1px solid var(--border-color);
      padding-top: 12px;
    }

    .side-title {
      padding: 10px 20px;
      font-size: 12px;
      color: var(--text-sub);
    }

    .side-item {
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .side-item:hover {
      background-color: #f5f5f5;
    }

    .side-item.active {
      background: #e0fbf9;
      color: var(--primary-color);
      font-weight: 600;
    }

    .content {
      flex: 1;
      padding: 20px 28px;
      overflow-y: auto;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 800;
    }

    .order-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
    }

    .order-card {
      background: #fff;
      border-radius: 14px;
      padding: 14px 14px 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border: 1px solid #f1f1f1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .order-header-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .order-id {
      font-weight: 700;
    }

    .order-status-tag {
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 12px;
    }

    .status-warn {
      background: #fff7e6;
      color: #fa8c16;
    }

    .status-info {
      background: #e6f7ff;
      color: #1890ff;
    }

    .status-success {
      background: #f6ffed;
      color: #52c41a;
    }

    .status-error {
      background: #fff1f0;
      color: #f5222d;
    }

    .order-line {
      color: #555;
    }

    .order-footer {
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      color: var(--text-sub);
      font-size: 12px;
    }

    .dish-list {
      margin-top: 4px;
      padding-left: 14px;
      color: #666;
    }

    .dish-item {
      list-style: disc;
    }

    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }

    .menu-card {
      background: #fff;
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.03);
      border: 1px solid #f1f1f1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    .menu-header-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .menu-name {
      font-weight: 700;
    }

    .menu-price {
      color: #ff4d4f;
      font-weight: 700;
    }

    .stat-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 6px;
    }

    .stat-card {
      background: #fff;
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.03);
      border: 1px solid #f1f1f1;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 800;
    }

    .dialog-tip {
      font-size: 12px;
      color: #999;
      margin-top: 4px;
    }

    /* 头像下拉：店铺资料 / 退出登录 居中 */
    .el-dropdown-menu__item {
      justify-content: center;
    }

    /* 加载中样式 */
.loading-wrap {
  text-align: center;
  padding: 40px 0;
  color: #999;
}
 

/* 弹窗兜底样式 */
.el-dialog__body {
  padding: 20px;
  overflow: visible !important;
}
.el-dialog {
  min-width: 500px !important;
}
  </style>
</head>
<body>
<div id="app">
  <!-- 登录 -->
  <div v-if="!currentShop" class="login-mask">
    <div class="login-card">
      <div class="brand-logo">
        <div class="brand-icon">
          <el-icon><Food /></el-icon>
        </div>
        <div class="brand-text">饭团商家端</div>
      </div>
      <p style="font-size:13px;color:#666;margin-bottom:16px;">
        请输入商家账号和密码登录
      </p>
      <el-form :model="loginForm" @submit.prevent>
        <el-form-item>
          <el-input v-model="loginForm.username" placeholder="商家用户名">
            <template #prefix>
              <el-icon><User /></el-icon>
            </template>
          </el-input>
        </el-form-item>
        <el-form-item>
          <el-input
            v-model="loginForm.password"
            type="password"
            placeholder="密码"
            show-password
          >
            <template #prefix>
              <el-icon><Lock /></el-icon>
            </template>
          </el-input>
        </el-form-item>
        <el-button
          type="primary"
          style="width:100%;border-radius:20px;margin-top:4px;"
          @click="handleLogin"
          :loading="loginLoading"
        >
          登录 / 进入商家工作台
        </el-button>
      </el-form>
    </div>
  </div>

  <!-- 主界面 -->
  <template v-else>
    <!-- 顶部栏 -->
    <header class="shop-header">
      <div class="shop-header-left">
        <div class="shop-logo">
          <el-icon><Shop /></el-icon>
        </div>
        <div class="shop-info-main">
          <div class="shop-name">{{ currentShop.shop_name }}</div>
          <div class="shop-sub">
            状态：{{ shopStatusText }} · 配送范围 {{ (parseFloat(currentShop.delivery_range)||0).toFixed(1) }}km · 配送费 ¥{{ (parseFloat(currentShop.delivery_fee)||0).toFixed(2) }} · 经营时间 {{ currentShop.business_hours }}
          </div>
        </div>
      </div>
      <div class="shop-header-right">
        <div style="display:flex;align-items:center;gap:6px;">
          <div
            class="status-dot"
            :style="{background: shopOpen ? '#52c41a' : '#ff4d4f'}"
          ></div>
          <span>{{ currentShop?.status === 1 ? '营业中' : '打烊' }}</span>
          <el-switch v-model="shopOpen" @change="toggleShopOpen" />
        </div>

        <el-dropdown @command="handleUserCommand">
          <span style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <el-avatar :size="30" style="background:#e0fbf9;color:var(--primary-color);">
              {{ (currentShop.shop_name || '商家')[0] }}
            </el-avatar>
            <span style="font-size:13px;">{{ currentShop.shop_name || '商家' }}</span>
            <el-icon><CaretBottom /></el-icon>
          </span>
          <template #dropdown>
            <el-dropdown-menu>
              <el-dropdown-item command="profile">店铺资料</el-dropdown-item>
              <el-dropdown-item divided command="logout" style="color:#f56c6c;">
                退出登录
              </el-dropdown-item>
            </el-dropdown-menu>
          </template>
        </el-dropdown>
      </div>
    </header>

    <!-- 主布局 -->
    <div class="layout-main">
      <!-- 左侧导航 -->
      <aside class="side-nav">
        <div class="side-title">工作台</div>
        <div
          class="side-item"
          :class="{active: activeMenu === 'orders'}"
          @click="activeMenu = 'orders'"
        >
          <el-icon><List /></el-icon><span>当前订单</span>
        </div>
        <div
          class="side-item"
          :class="{active: activeMenu === 'menu'}"
          @click="activeMenu = 'menu'"
        >
          <el-icon><Dish /></el-icon><span>菜单管理</span>
        </div>
        <div
          class="side-item"
          :class="{active: activeMenu === 'stats'}"
          @click="activeMenu = 'stats'"
        >
          <el-icon><Histogram /></el-icon><span>营收概览</span>
        </div>
      </aside>

      <!-- 内容 -->
      <main class="content">
        <!-- 订单管理 -->
        <section v-if="activeMenu === 'orders'">
          <div class="section-header">
            <div class="section-title">当前订单</div>
            <div style="display:flex;gap:8px;align-items:center;">
              <el-select v-model="orderStatusFilter" size="small" style="width:150px;">
                <el-option label="全部状态" value="all"></el-option>
                <el-option label="待支付" value="1"></el-option>
                <el-option label="待接单" value="2"></el-option>
                <el-option label="待配送" value="4"></el-option>
                <el-option label="配送中" value="5"></el-option>
                <el-option label="已完成" value="6"></el-option>
                <el-option label="已取消（用户/商家）" value="cancel"></el-option>
              </el-select>
              <el-button size="small" @click="refreshOrders" :loading="orderLoading">
                <el-icon><Refresh /></el-icon>刷新
              </el-button>
            </div>
          </div>

          <!-- 加载中 -->
          <div v-if="orderLoading" class="loading-wrap">
            <el-icon size="40"><Loading /></el-icon>
            <p>加载订单中...</p>
          </div>

          <div v-else-if="displayOrders.length === 0" style="text-align:center;color:#999;padding:40px 0;">
            <el-icon size="40"><DocumentRemove /></el-icon>
            <p>当前暂无订单</p>
          </div>

          <div class="order-grid" v-else>
            <div
              v-for="o in displayOrders"
              :key="o.order_id"
              class="order-card"
            >
              <div class="order-header-line">
                <div class="order-id">订单 #{{ o.order_id }}</div>
                <span class="order-status-tag" :class="statusClass(o.status)">
                  {{ statusText(o.status) }}
                </span>
              </div>
              <div class="order-line">
                用户：{{ o.user_name }}
              </div>
              <div class="order-line">
                地址：{{ o.address }}
              </div>
              <div class="order-line" v-if="o.deliverer_name">
                骑手：{{ o.deliverer_name }}（{{ o.deliverer_phone }}）
              </div>
              <ul class="dish-list">
                <li
                  v-for="d in o.items"
                  :key="d.dish_id || d.id"
                  class="dish-item"
                >
                  {{ d.dish_name }} x{{ d.quantity }} （¥{{ d.subtotal.toFixed(2) }}）
                </li>
              </ul>
              <div class="order-footer">
                <span>下单时间：{{ o.created_at }}</span>
                <span>总价：¥{{ o.total_amount.toFixed(2) }}</span>
              </div>

              <div style="margin-top:auto;display:flex;justify-content:flex-end;gap:6px;">
                <template v-if="o.status === 2">
                  <el-button size="small" type="primary" @click="acceptOrder(o)" :loading="operLoading">接单</el-button>
                  <el-button size="small" type="danger" plain @click="refuseOrder(o)" :loading="operLoading">拒单</el-button>
                </template>
                <template v-else-if="o.status === 8">
                  <el-button size="small" type="success" @click="markWaitingForDelivery(o)" :loading="operLoading">备餐完成</el-button>
                </template>
                <template v-else-if="o.status === 4">
                  <el-button size="small" disabled>待配送</el-button>
                </template>
                <template v-else-if="o.status === 5">
                  <el-button size="small" disabled>配送中</el-button>
                </template>
              </div>
            </div>
          </div>
        </section>

        <!-- 菜单管理 -->
        <section v-if="activeMenu === 'menu'">
          <div class="section-header">
            <div class="section-title">菜单管理</div>
            <div style="display:flex;gap:8px;align-items:center;">
              <span style="font-size:13px;color:#666;">共 {{ menus.length }} 张菜单</span>
              <span style="font-size:13px;color:#333;">当前菜单：{{ currentMenuName || '未选择' }}</span>
              <el-select v-model="selectedMenuId" size="small" style="width:180px;" placeholder="选择菜单" @change="onMenuChange" :disabled="menuLoading">
                <el-option v-for="m in menus" :key="m.menu_id" :label="m.menu_name" :value="m.menu_id" />
              </el-select>
              <el-button type="primary" size="small" @click="openAddMenu" :loading="operLoading">
                <el-icon><Plus /></el-icon>新增菜单
              </el-button>
              <el-button size="small" @click="openEditMenu" :disabled="!selectedMenuId || menuLoading" :loading="operLoading">
                <el-icon><Edit /></el-icon>编辑菜单
              </el-button>
              <el-button size="small" type="danger" plain @click="deleteMenu" :disabled="!selectedMenuId || menuLoading" :loading="operLoading">
                <el-icon><Delete /></el-icon>删除菜单
              </el-button>
              <el-button type="primary" size="small" @click="addDish" :loading="operLoading">
                <el-icon><Plus /></el-icon>新增菜品
              </el-button>
            </div>
          </div>

          <!-- 加载中 -->
          <div v-if="menuLoading" class="loading-wrap">
            <el-icon size="40"><Loading /></el-icon>
            <p>加载菜单/菜品中...</p>
          </div>

          <div v-else-if="menus.length === 0" style="text-align:center;color:#999;padding:40px 0;">
            <el-icon size="40"><FolderRemove /></el-icon>
            <p>暂无菜单，请先创建菜单</p>
          </div>

          <div v-else-if="menuForShop.length === 0" style="text-align:center;color:#999;padding:40px 0;">
            <el-icon size="40"><ShoppingCartEmpty /></el-icon>
            <p>当前菜单暂无菜品</p>
          </div>

          <div class="menu-grid" v-else>
            <div
              v-for="d in menuForShop"
              :key="d.dish_id"
              class="menu-card"
            >
              <div class="menu-header-line">
                <div class="menu-name">{{ d.dish_name }}</div>
                <div class="menu-price">¥{{ d.price.toFixed(2) }}</div>
              </div>
              <div style="font-size:12px;color:#777;">
                库存：{{ d.stock }} · 菜品ID：{{ d.dish_id }}
              </div>
              <div style="margin-top:4px;display:flex;justify-content:space-between;align-items:center;">
                <el-tag size="small" :type="d.status === 1 ? 'success' : 'info'">
                  {{ d.status === 1 ? '在售' : '停售' }}
                </el-tag>
                <div style="display:flex;gap:6px;">
                  <el-button size="small" text @click="toggleDishStatus(d)" :loading="operLoading">
                    {{ d.status === 1 ? '停售' : '上架' }}
                  </el-button>
                  <el-button size="small" text type="primary" @click="editDish(d)">
                    编辑
                  </el-button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 营收概览 -->
        <section v-if="activeMenu === 'stats'">
          <div class="section-header">
            <div class="section-title">营收概览</div>
            <div style="display:flex;align-items:center;gap:8px;">
              <el-button size="small" @click="refreshStats" :loading="statLoading">
                <el-icon><Refresh /></el-icon>刷新
              </el-button>
            </div>
          </div>

          <!-- 加载中 -->
          <div v-if="statLoading" class="loading-wrap">
            <el-icon size="40"><Loading /></el-icon>
            <p>加载营收数据中...</p>
          </div>

          <div class="stat-cards" v-else>
            <div class="stat-card">
              <div class="stat-label">今日订单数</div>
              <div class="stat-value">{{ todayOrderCount }}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">今日营业额</div>
              <div class="stat-value">¥{{ todayRevenue.toFixed(2) }}</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">待处理订单</div>
              <div class="stat-value">{{ pendingCount }}</div>
            </div>
          </div>

          <div v-show="!statLoading" style="margin-top:16px;display:flex;flex-direction:column;gap:16px;">
            <div style="background:#fff;border:1px solid #f1f1f1;border-radius:12px;padding:12px;">
              <div style="font-weight:700;margin-bottom:8px;">历史趋势 · 订单数</div>
              <canvas ref="orderChart" style="width:100%;height:220px;"></canvas>
            </div>
            <div style="background:#fff;border:1px solid #f1f1f1;border-radius:12px;padding:12px;">
              <div style="font-weight:700;margin-bottom:8px;">历史趋势 · 营业额（¥）</div>
              <canvas ref="revenueChart" style="width:100%;height:220px;"></canvas>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- 菜品编辑弹窗 -->
    <el-dialog
      v-model="editDialogVisible"
      title="编辑菜品"
      width="420px"
    >
      <el-form :model="editForm" label-width="80px">
        <el-form-item label="菜品ID">
          <span>{{ editForm.dish_id || '新增菜品' }}</span>
        </el-form-item>
        <el-form-item label="菜名">
          <el-input
            v-model="editForm.dish_name"
            placeholder="请输入菜品名称"
          ></el-input>
        </el-form-item>
        <el-form-item label="价格">
          <el-input-number
            v-model="editForm.price"
            :min="0"
            :step="0.5"
            :precision="2"
            style="width: 180px;"
          ></el-input-number>
          <span style="margin-left:8px;">元</span>
        </el-form-item>
        <el-form-item label="库存">
          <el-input-number
            v-model="editForm.stock"
            :min="0"
            :step="1"
            style="width: 180px;"
          ></el-input-number>
        </el-form-item>
        <el-form-item label="所属菜单" v-if="!editForm.dish_id">
          <el-select v-model="editForm.menu_name" placeholder="选择菜单" style="width: 180px;">
            <el-option v-for="m in menus" :key="m.menu_id" :label="m.menu_name" :value="m.menu_name" />
          </el-select>
        </el-form-item>
        <el-form-item label="状态">
          <el-radio-group v-model="editForm.status">
            <el-radio :label="1">在售</el-radio>
            <el-radio :label="0">停售</el-radio>
          </el-radio-group>
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="editDialogVisible = false">取消</el-button>
          <el-button type="primary" @click="saveDishEdit" :loading="operLoading">保存</el-button>
        </span>
      </template>
    </el-dialog>

    <!-- 菜单编辑弹窗 -->
    <el-dialog
      v-model="menuEditDialogVisible"
      :title="menuEditForm.menu_id ? '编辑菜单' : '新增菜单'"
      width="420px"
    >
      <el-form :model="menuEditForm" label-width="80px">
        <el-form-item label="菜单ID">
          <span>{{ menuEditForm.menu_id || '新增菜单' }}</span>
        </el-form-item>
        <el-form-item label="菜单名称">
          <el-input v-model="menuEditForm.menu_name" placeholder="请输入菜单名称"></el-input>
        </el-form-item>
        <el-form-item label="状态">
          <el-switch v-model="menuEditForm.status" :active-value="1" :inactive-value="0" active-text="启用" inactive-text="停用"></el-switch>
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="menuEditDialogVisible = false">取消</el-button>
          <el-button type="primary" @click="saveMenuEdit" :loading="operLoading">保存</el-button>
        </span>
      </template>
    </el-dialog>

    <!-- 店铺资料编辑弹窗 -->
    <el-dialog
      v-model="shopProfileDialogVisible"
      title="编辑店铺资料"
      width="480px"
    >
      <el-form :model="shopProfileForm" label-width="90px">
        <el-form-item label="店铺名称">
          <el-input v-model="shopProfileForm.shop_name" placeholder="请输入店铺名称"></el-input>
        </el-form-item>
        <el-form-item label="配送范围">
          <el-input-number
            v-model="shopProfileForm.delivery_range"
            :min="0"
            :step="0.5"
            style="width:180px;"
          ></el-input-number>
          <span style="margin-left:8px;">公里</span>
        </el-form-item>
        <el-form-item label="配送费">
          <el-input-number
            v-model="shopProfileForm.delivery_fee"
            :min="0"
            :step="0.5"
            :precision="2"
            style="width:180px;"
          ></el-input-number>
          <span style="margin-left:8px;">元</span>
        </el-form-item>
        <el-form-item label="营业时间">
          <el-input v-model="shopProfileForm.business_hours" placeholder="例如 10:00-22:00"></el-input>
        </el-form-item>
        
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="shopProfileDialogVisible = false">取 消</el-button>
          <el-button type="primary" @click="saveShopProfile">保 存</el-button>
        </span>
      </template>
    </el-dialog>
  </template>
</div>

<script>
  const { createApp } = Vue;

  const App = {
    data() {
      return {
        // 登录相关
        loginForm: {
          username: 'admin',
          password: 'admin'
        },
        loginLoading: false,
        // 核心状态
        currentShop: null,
        shopOpen: false,
        activeMenu: 'orders',
        // 订单相关
        orderStatusFilter: 'all',
        orders: [],
        orderItemsMap: {},
        usernamesMap: {},
        addressesMap: {},
        orderLoading: false,
        // 菜单/菜品相关
        dishes: [],
        menus: [],
        selectedMenuId: null,
        menuLoading: false,
        // 营收相关
        statLoading: false,
        statsTodayOrderCount: 0,
        statsTodayRevenue: 0,
        seriesOrderCount: [],
        seriesRevenue: [],
        // 操作加载状态
        operLoading: false,
        // 编辑菜品弹窗
        editDialogVisible: false,
        editForm: {
          dish_id: null,
          shop_id: null,
          dish_name: '',
          price: 0,
          stock: 0,
          status: 1
        },
        menuEditDialogVisible: false,
        menuEditForm: {
          menu_id: null,
          menu_name: '',
          status: 1
        },
        // 店铺资料编辑弹窗
        shopProfileDialogVisible: false,
        shopProfileForm: {
          shop_name: '',
          delivery_range: 0,
          delivery_fee: 0,
          business_hours: ''
        }
      };
    },
    computed: {
      displayOrders() {
        if (!this.currentShop || this.orderLoading) return [];
        return this.orders.map(o => ({
          ...o,
          user_name: this.usernamesMap[o.user_id || o.UserID] || '未知用户',
          address: this.addressesMap[o.user_id || o.UserID] || '未知地址',
          deliverer_name: '',
          deliverer_phone: '',
          items: this.orderItemsMap[o.order_id || o.OrderID] || []
        })).filter(o => {
          if (this.orderStatusFilter === 'all') return true;
          if (this.orderStatusFilter === 'cancel') {
            return [3,7].includes(o.status || o.Status);
          }
          return (o.status || o.Status) === Number(this.orderStatusFilter);
        });
      },
      // 当前菜单的菜品
      menuForShop() {
        if (!this.currentShop || this.menuLoading) return [];
        return this.dishes;
      },
      // 当前选中菜单名称
      currentMenuName() {
        if (!this.selectedMenuId || this.menuLoading) return '';
        const menu = this.menus.find(m => m.menu_id === this.selectedMenuId);
        return menu ? (menu.menu_name || '未命名菜单') : '';
      },
      // 今日订单数
      todayOrderCount() {
        return this.statsTodayOrderCount || 0;
      },
      // 今日营业额
      todayRevenue() {
        return this.statsTodayRevenue || 0;
      },
      // 待处理订单数
      pendingCount() {
        return this.orders.filter(o => {
          const status = o.status || o.Status;
          return [1,2,4,5,8].includes(status);
        }).length;
      },
      // 店铺状态文本
      shopStatusText() {
        const status = this.currentShop?.status;
        return status === 1 ? '营业中' : '休息中';
      },
      // 店铺类型文本
      
    },
    watch: {
      activeMenu(val) {
        if (val === 'stats') this.refreshStats();
      }
    },
    methods: {
      // 统一请求封装（处理超时、错误）
      async request(url, options = {}) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10秒超时

        try {
          const res = await fetch(url, {
            ...options,
            signal: controller.signal,
            headers: {
              'Content-Type': 'application/json',
              ...options.headers
            }
          });

          clearTimeout(timeoutId);
          
          if (!res.ok) {
            throw new Error(`接口请求失败：${res.status} ${res.statusText}`);
          }

          const data = await res.json();
          return data;
        } catch (e) {
          clearTimeout(timeoutId);
          if (e.name === 'AbortError') {
            throw new Error('接口请求超时，请检查网络');
          }
          throw e;
        }
      },
      // 登录
      async handleLogin() {
        const name = this.loginForm.username.trim();
        const pwd = this.loginForm.password.trim();
        if (!name || !pwd) {
          ElementPlus.ElMessage.warning('请输入用户名和密码');
          return;
        }

        this.loginLoading = true;
        try {
          // 1. 登录接口
          const loginRes = await this.request('/shop/login', {
            method: 'POST',
            body: JSON.stringify({ username: name, password: pwd })
          });

          if (!loginRes.shop_id && !loginRes.ShopID) {
            throw new Error('登录失败：未返回店铺ID');
          }

          const shopId = loginRes.shop_id || loginRes.ShopID;

        // 2. 从 /shop/getall 获取所有店铺，并定位当前店铺
        const allShops = await this.request('/shop/getall', { method: 'POST' });
        const shopItem = Array.isArray(allShops)
          ? allShops.find(s => (s.shop_id || s.ShopID) === shopId)
          : allShops;
        if (!shopItem) {
          throw new Error('未查询到店铺信息');
        }

        // 3. 初始化店铺基础信息（全部来自 /shop/getall）
        const sname = shopItem.shop_name || shopItem.ShopName || name;
        const drange = this.formatNumber(shopItem.delivery_range || shopItem.DeliveryRange);
        const dfee = this.formatNumber(shopItem.delivery_fee || shopItem.DeliveryFee);
        const bhours = shopItem.business_hours || shopItem.BusinessHours || '';
        const status = Number(shopItem.status ?? shopItem.Status ?? 0);
        const stype = Number(shopItem.type ?? shopItem.Type ?? 0);
        this.currentShop = {
          shop_id: shopId,
          shop_name: sname,
          delivery_range: drange,
          delivery_fee: dfee,
          business_hours: bhours,
          status: status,
          type: stype
        };
        this.shopOpen = status === 1;

          // 5. 加载基础数据
          await Promise.all([
            this.loadOrders(),
            this.loadMenus()
          ]);

          ElementPlus.ElMessage.success('登录成功');
        } catch (e) {
          ElementPlus.ElMessage.error({message: e.message || '登录失败', duration: 10000});
        } finally {
          this.loginLoading = false;
        }
      },
      
      // 加载订单
      async loadOrders() {
        if (!this.currentShop) return;

        this.orderLoading = true;
        try {
          // 1. 获取店铺订单
          const orderRes = await this.request(`/shop/getordersbyshopid?shop_id=${encodeURIComponent(this.currentShop.shop_id)}`);
          this.orders = Array.isArray(orderRes) ? orderRes.map(o => ({
            order_id: o.order_id || o.OrderID || o.id,
            user_id: o.user_id || o.UserID,
            shop_id: o.shop_id || o.ShopID,
            deliverer_id: o.deliverer_id || o.DelivererID,
            total_amount: this.formatNumber(o.total_amount || o.TotalAmount),
            status: o.status || o.Status,
            created_at: o.created_at || o.CreatedAt || ''
          })) : [];

          // 2. 获取订单菜品明细
          await this.fetchOrderDishesForOrders();

          // 3. 获取订单用户姓名
          await this.fetchUsernamesForOrders();

          // 4. 获取订单用户地址
          await this.fetchAddressesForOrders();

          // 5. 加载营收数据
          this.loadStats();
        } catch (e) {
          ElementPlus.ElMessage.error('订单加载失败：' + e.message);
          this.orders = [];
          this.orderItemsMap = {};
          this.usernamesMap = {};
          this.addressesMap = {};
        } finally {
          this.orderLoading = false;
        }
      },
      // 加载订单菜品明细（修复价格为 0 的问题）
      async fetchOrderDishesForOrders() {
        if (!this.orders.length) {
          this.orderItemsMap = {};
          return;
        }

        try {
          const tasks = this.orders.map(o => {
            const orderId = o.order_id || o.OrderID;
            return this.request('/shop/getorderdishesbyshopid', {
              method: 'POST',
              body: JSON.stringify({ OrderID: orderId })
            }).then(res => {
              const items = Array.isArray(res) ? res.map(d => {
                const quantity = d.quantity || d.Quantity || 1;
                const unitPrice = this.formatNumber(
                  d.unit_price || d.UnitPrice || d.price || d.Price
                );
                let subtotal = this.formatNumber(d.subtotal || d.Subtotal);
                // 如果接口没返回 subtotal，就自己算 单价 * 数量
                if (!subtotal && unitPrice) {
                  subtotal = this.formatNumber(unitPrice * quantity);
                }
                return {
                  dish_id: d.dish_id || d.DishID,
                  dish_name: d.dish_name || d.DishName || '未知菜品',
                  quantity,
                  unit_price: unitPrice,
                  subtotal
                };
              }) : [];
              return { orderId, items };
            }).catch(() => ({ orderId, items: [] }));
          });

          const results = await Promise.all(tasks);
          const map = {};
          results.forEach(({ orderId, items }) => {
            if (orderId) map[orderId] = items;
          });
          this.orderItemsMap = map;
        } catch (e) {
          ElementPlus.ElMessage.warning('订单菜品明细加载失败：' + e.message);
          this.orderItemsMap = {};
        }
      },
      // 加载订单用户地址
      async fetchAddressesForOrders() {
        const ids = [...new Set(this.orders.map(o => o.user_id || o.UserID).filter(v => v !== undefined && v !== null))];
        if (!ids.length) { this.addressesMap = {}; return; }
        try {
          const tasks = ids.map(id => this.request('/user/getuseraddressbyuserid', {
            method: 'POST',
            body: JSON.stringify({ user_id: id })
          }).then(res => ({ id, address: res?.address || res?.MainAddress || '未知地址' })).catch(() => ({ id, address: '未知地址' })));
          const results = await Promise.all(tasks);
          const map = {};
          results.forEach(({ id, address }) => { map[id] = address; });
          this.addressesMap = map;
        } catch (e) {
          ElementPlus.ElMessage.warning('用户地址加载失败：' + e.message);
          this.addressesMap = {};
        }
      },
      // 加载订单用户姓名
      async fetchUsernamesForOrders() {
        const ids = [...new Set(this.orders.map(o => o.user_id || o.UserID).filter(v => v !== undefined && v !== null))];
        if (!ids.length) { this.usernamesMap = {}; return; }
        try {
          const tasks = ids.map(id => this.request('/user/getusernamebyuserid', {
            method: 'POST',
            body: JSON.stringify({ user_id: id })
          }).then(res => ({ id, username: res?.username || res?.UserName || '未知用户' })).catch(() => ({ id, username: '未知用户' })));
          const results = await Promise.all(tasks);
          const map = {};
          results.forEach(({ id, username }) => { map[id] = username; });
          this.usernamesMap = map;
        } catch (e) {
          ElementPlus.ElMessage.warning('用户姓名加载失败：' + e.message);
          this.usernamesMap = {};
        }
      },
      // 加载菜单
      async loadMenus() {
        if (!this.currentShop) return;

        this.menuLoading = true;
        try {
          // 1. 获取店铺菜单列表
          const menuRes = await this.request('/menu/getmenubyshopid', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ shop_id: String(this.currentShop.shop_id) })
          });

          this.menus = Array.isArray(menuRes) ? menuRes.map(m => ({
            menu_id: m.menu_id || m.MenuID || m.id,
            shop_id: m.shop_id || m.ShopID,
            menu_name: m.menu_name || m.MenuName || '未命名菜单',
            status: (m.status !== undefined && m.status !== null) ? m.status : ((m.Status !== undefined && m.Status !== null) ? m.Status : 1)
          })) : [];

          // 2. 默认选中第一个菜单
          if (!this.selectedMenuId && this.menus.length > 0) {
            this.selectedMenuId = this.menus[0].menu_id;
            await this.loadDishesForMenu(this.selectedMenuId);
          }
        } catch (e) {
          ElementPlus.ElMessage.error('菜单加载失败：' + e.message);
          this.menus = [];
        } finally {
          this.menuLoading = false;
        }
      },
      // 切换菜单
      async onMenuChange(menuId) {
        if (!menuId || !this.currentShop) return;
        this.selectedMenuId = menuId;
        await this.loadDishesForMenu(menuId);
      },
      openAddMenu() {
        if (!this.currentShop) return;
        this.menuEditForm = {
          menu_id: null,
          menu_name: '',
          status: 1
        };
        this.menuEditDialogVisible = true;
      },
      openEditMenu() {
        if (!this.currentShop || !this.selectedMenuId) return;
        const m = this.menus.find(x => x.menu_id === this.selectedMenuId);
        if (!m) return;
        this.menuEditForm = {
          menu_id: m.menu_id,
          menu_name: m.menu_name || '',
          status: Number(m.status ?? 1)
        };
        this.menuEditDialogVisible = true;
      },
      async saveMenuEdit() {
        if (!this.currentShop) return;
        if (!this.menuEditForm.menu_name || !this.menuEditForm.menu_name.trim()) {
          ElementPlus.ElMessage.warning('菜单名称不能为空');
          return;
        }
        this.operLoading = true;
        try {
          const isUpdate = !!this.menuEditForm.menu_id;
          const statusRaw = (this.menuEditForm.status ?? 1);
          const statusNum = Number(statusRaw);
          const finalStatus = statusNum === 0 ? 0 : 1;
          const payload = isUpdate
            ? { action: 'update', menu_id: this.menuEditForm.menu_id, menu_name: this.menuEditForm.menu_name.trim(), status: finalStatus }
            : { action: 'add', menu_id: this.currentShop.shop_id, menu_name: this.menuEditForm.menu_name.trim(), status: finalStatus };
          await this.request('/menu/updatemenu', { method: 'POST', body: JSON.stringify(payload) });
          await this.loadMenus();
          if (!isUpdate) {
            const created = this.menus.find(m => (m.menu_name || '') === this.menuEditForm.menu_name);
            if (created) {
              this.selectedMenuId = created.menu_id;
              await this.loadDishesForMenu(this.selectedMenuId);
            }
          }
          this.menuEditDialogVisible = false;
          ElementPlus.ElMessage.success(isUpdate ? '菜单已更新' : '菜单已新增');
        } catch (e) {
          ElementPlus.ElMessage.error('菜单保存失败：' + e.message);
        } finally {
          this.operLoading = false;
        }
      },
      async deleteMenu() {
        if (!this.currentShop || !this.selectedMenuId) return;
        try {
          await ElementPlus.ElMessageBox.confirm('确定删除当前菜单吗？其下菜品关联也将清除', '提示', { type: 'warning' });
        } catch (_) { return; }
        this.operLoading = true;
        try {
          await this.request('/menu/updatemenu', { method: 'POST', body: JSON.stringify({ action: 'delete', menu_id: this.selectedMenuId }) });
          await this.loadMenus();
          if (this.menus.length > 0) {
            this.selectedMenuId = this.menus[0].menu_id;
            await this.loadDishesForMenu(this.selectedMenuId);
          } else {
            this.selectedMenuId = null;
            this.dishes = [];
          }
          ElementPlus.ElMessage.success('菜单已删除');
        } catch (e) {
          ElementPlus.ElMessage.error('删除失败：' + e.message);
        } finally {
          this.operLoading = false;
        }
      },
      // 加载菜单下的菜品
      async loadDishesForMenu(menuId) {
        if (!menuId || !this.currentShop) return;

        this.menuLoading = true;
        try {
          const dishRes = await this.request('/menu/getdishesbymenuid', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ menu_id: String(menuId) })
          });

          this.dishes = Array.isArray(dishRes) ? dishRes.map(d => ({
            dish_id: d.dish_id || d.DishID || d.id,
            shop_id: d.shop_id || d.ShopID,
            dish_name: d.dish_name || d.DishName || '',
            price: this.formatNumber(d.price || d.Price),
            stock: d.stock || d.Stock || 0,
            status: d.status || d.Status || 0
          })) : [];
        } catch (e) {
          ElementPlus.ElMessage.error('菜品加载失败：' + e.message);
          this.dishes = [];
        } finally {
          this.menuLoading = false;
        }
      },
      // 加载店铺元信息（配送费、营业时间等）
      async fetchShopMeta(shopId) {
        if (!shopId) return;

        try {
          const [feeRes, hoursRes, statusRes, typeRes] = await Promise.all([
            this.request('/shop/getdeliveryfeebyshopid', {
              method: 'POST',
              body: JSON.stringify({ shop_id: shopId })
            }),
            this.request('/shop/getbussinesshoursbyshopid', {
              method: 'POST',
              body: JSON.stringify({ shop_id: shopId })
            }),
            this.request('/shop/getshopstatusbyshopid', {
              method: 'POST',
              body: JSON.stringify({ shop_id: shopId })
            }),
            this.request('/shop/getshoptypebyshopid', {
              method: 'POST',
              body: JSON.stringify({ shop_id: shopId })
            })
          ]);

          // 配送费
          this.currentShop.delivery_fee = this.formatNumber(feeRes?.delivery_fee || feeRes?.DeliveryFee || 0);
          // 营业时间
          this.currentShop.business_hours = hoursRes?.business_hours || hoursRes?.BusinessHours || '';
          // 店铺状态
          const status = statusRes?.status ?? statusRes?.Status ?? 0; 
          this.currentShop.status = status;
          this.shopOpen = status === 1;
          // 店铺类型
          this.currentShop.type = typeRes?.type || typeRes?.Type || 0;
          console.log('status接口返回值：', statusRes);
        } catch (e) {
          ElementPlus.ElMessage.warning('店铺元信息加载失败：' + e.message);
        }
      },
      // 加载营收数据
      async loadStats() {
        this.statLoading = true;
        try {
          const [cntRes, revRes] = await Promise.all([
            this.request('/shop/gettodayordercountbyshopid', {
              method: 'POST',
              body: JSON.stringify({ shop_id: this.currentShop.shop_id })
            }),
            this.request('/shop/gettodayrevenuebyshopid', {
              method: 'POST',
              body: JSON.stringify({ shop_id: this.currentShop.shop_id })
            })
          ]);
          const count = cntRes?.count ?? cntRes?.Count ?? 0;
          const revenue = revRes?.revenue ?? revRes?.Revenue ?? 0;
          this.statsTodayOrderCount = Number(count) || 0;
          this.statsTodayRevenue = Number(typeof revenue === 'string' ? parseFloat(revenue) : revenue) || 0;

          await this.loadTrendData();
        } catch (e) {
          ElementPlus.ElMessage.warning('营收数据加载失败：' + e.message);
        }
        this.statLoading = false;
        await Vue.nextTick();
        this.drawLineChart(this.$refs.orderChart, this.seriesOrderCount, '#00cbd3');
        this.drawLineChart(this.$refs.revenueChart, this.seriesRevenue, '#52c41a');
      },
      async loadTrendData() {
        if (!this.currentShop) return;
        try {
          const [countListRes, revenueListRes] = await Promise.all([
            this.request('/shop/getallordercountbyshopid', {
              method: 'POST',
              body: JSON.stringify({ shop_id: this.currentShop.shop_id })
            }),
            this.request('/shop/getallrevenuebyshopid', {
              method: 'POST',
              body: JSON.stringify({ shop_id: this.currentShop.shop_id })
            })
          ]);
          const countRaw = countListRes?.count ?? countListRes?.Count ?? countListRes;
          const revenueRaw = revenueListRes?.revenue ?? revenueListRes?.Revenue ?? revenueListRes;
          this.seriesOrderCount = this.normalizeSeries(countRaw, ['order_count','OrderCount','count','Count','value','Value'])
          this.seriesRevenue = this.normalizeSeries(revenueRaw, ['revenue','Revenue','amount','Amount','value','Value']);
        } catch (e) {
          ElementPlus.ElMessage.warning('趋势数据加载失败：' + e.message);
          this.seriesOrderCount = [];
          this.seriesRevenue = [];
        }
      },
      normalizeSeries(raw, valueKeys) {
        const out = [];
        if (!raw) return out;
        if (Array.isArray(raw)) {
          raw.forEach((d, i) => {
            if (d && typeof d === 'object') {
              let date = d.date || d.Date || d.day || d.Day || `D${i+1}`;
              if (typeof date === 'string' && date.includes('T')) {
                date = date.split('T')[0];
              }
              let val;
              for (const k of valueKeys) { if (d[k] !== undefined) { val = d[k]; break; } }
              if (val === undefined) val = d.value || d.Value || 0;
              out.push({ date: String(date), value: Number(typeof val === 'string' ? parseFloat(val) : val) || 0 });
            } else {
              out.push({ date: `D${i+1}`, value: Number(d) || 0 });
            }
          });
        } else if (typeof raw === 'object') {
          Object.entries(raw).forEach(([k, v]) => {
            out.push({ date: String(k), value: Number(typeof v === 'string' ? parseFloat(v) : v) || 0 });
          });
        }
        return out;
      },
      drawLineChart(canvasEl, series, color) {
        try {
          if (!canvasEl || !series || series.length === 0) return;
          const el = canvasEl;
          const parent = el.parentElement;
          const cssW = Math.max(400, parent.clientWidth - 24);
          const cssH = 220;
          const ratio = Math.max(1, Math.floor(window.devicePixelRatio || 1));
          el.style.width = cssW + 'px';
          el.style.height = cssH + 'px';
          el.width = Math.floor(cssW * ratio);
          el.height = Math.floor(cssH * ratio);
          const ctx = el.getContext('2d');
          ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
          ctx.clearRect(0, 0, cssW, cssH);
          const padding = { left: 56, right: 24, top: 16, bottom: 46 };
          const plotW = cssW - padding.left - padding.right;
          const plotH = cssH - padding.top - padding.bottom;
          const xRight = padding.left + plotW - 8;
          const values = series.map(s => s.value);
          const minV = Math.min(...values, 0);
          const maxV = Math.max(...values, 1);
          const yRange = (maxV - minV) || 1;
          const stepX = series.length > 1 ? (plotW / (series.length - 1)) : 0;
          const yScale = plotH / yRange;
          ctx.strokeStyle = '#ddd';
          ctx.beginPath();
          ctx.moveTo(padding.left, padding.top + plotH);
          ctx.lineTo(padding.left + plotW, padding.top + plotH);
          ctx.moveTo(padding.left, padding.top);
          ctx.lineTo(padding.left, padding.top + plotH);
          ctx.stroke();

          const yTicks = 5;
          const yStep = yRange / yTicks;
          ctx.font = '12px Noto Sans SC';
          for (let i = 0; i <= yTicks; i++) {
            const val = minV + i * yStep;
            const y = padding.top + plotH - (val - minV) * yScale;
            ctx.strokeStyle = '#f2f2f2';
            ctx.beginPath();
            ctx.moveTo(padding.left, y);
            ctx.lineTo(padding.left + plotW, y);
            ctx.stroke();
            const label = yStep >= 1 ? Math.round(val).toString() : val.toFixed(2);
            ctx.fillStyle = '#999';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            ctx.fillText(label, padding.left - 6, y);
          }

          ctx.strokeStyle = color;
          ctx.lineWidth = 2;
          ctx.beginPath();
          series.forEach((s, i) => {
            let x = padding.left + i * stepX;
            if (x > xRight) x = xRight;
            const y = padding.top + plotH - (s.value - minV) * yScale;
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
          });
          ctx.stroke();

          ctx.fillStyle = color;
          series.forEach((s, i) => {
            let x = padding.left + i * stepX;
            if (x > xRight) x = xRight;
            const y = padding.top + plotH - (s.value - minV) * yScale;
            ctx.beginPath();
            ctx.arc(x, y, 3, 0, Math.PI * 2);
            ctx.fill();
          });

          const minSpacing = 60;
          const stepLabel = Math.max(1, Math.ceil(minSpacing / stepX));
          ctx.fillStyle = '#666';
          ctx.font = '12px Noto Sans SC';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'top';
          for (let i = 0; i < series.length; i += stepLabel) {
            let x = padding.left + i * stepX;
            if (x > xRight) x = xRight;
            if (x < padding.left) x = padding.left;
            const y = padding.top + plotH + 6;
            const text = String(series[i].date);
            ctx.fillText(text, x, y);
          }
        } catch (e) {}
      },
      // 切换店铺营业状态
      async toggleShopOpen(val) {
        if (!this.currentShop) return;

        const status = val ? 1 : 0;
        try {
          await this.request('/shop/updateshopstatus', {
            method: 'POST',
            body: JSON.stringify({ 
              ShopID: this.currentShop.shop_id, 
              Status: status 
            })
          });

          this.currentShop.status = status;
          ElementPlus.ElMessage.success(val ? '已设置为营业中' : '已设置为打烊');
        } catch (e) {
          this.shopOpen = !val ? 0 : 1;
          ElementPlus.ElMessage.error('状态更新失败：' + e.message);
        }
      },
      // 用户下拉菜单操作
      handleUserCommand(cmd) {
        if (cmd === 'logout') {
          ElementPlus.ElMessageBox.confirm('确定退出登录吗？', '提示', {
            confirmButtonText: '退出',
            cancelButtonText: '取消',
            type: 'warning'
          }).then(() => {
            this.currentShop = null;
            // 清空所有数据
            this.orders = [];
            this.dishes = [];
            this.menus = [];
            this.users = [];
            this.deliverers = [];
            this.selectedMenuId = null;
          }).catch(() => {});
        } else if (cmd === 'profile') {
          this.openShopProfile();
        }
      },
      // 打开店铺资料编辑弹窗
      openShopProfile() {
        if (!this.currentShop) return;
        this.shopProfileForm = {
          shop_name: this.currentShop.shop_name || '',
          delivery_range: Number(this.currentShop.delivery_range || 0),
          delivery_fee: Number(this.currentShop.delivery_fee || 0),
          business_hours: this.currentShop.business_hours || ''
        };
        this.shopProfileDialogVisible = true;
      },
      // 保存店铺资料（后端持久化）
      async saveShopProfile() {
        if (!this.currentShop) return;
        const name = (this.shopProfileForm.shop_name || '').trim();
        if (!name) {
          ElementPlus.ElMessage.warning('店铺名称不能为空');
          return;
        }
        const payload = {
          shop_id: this.currentShop.shop_id,
          shop_name: name,
          delivery_range: this.formatNumber(this.shopProfileForm.delivery_range),
          delivery_fee: this.formatNumber(this.shopProfileForm.delivery_fee),
          business_hours: (this.shopProfileForm.business_hours || '').trim()
        };
        try {
          await this.request('/shop/updateshopinfo', {
            method: 'POST',
            body: JSON.stringify(payload)
          });
          // 本地状态同步
          this.currentShop.shop_name = payload.shop_name;
          this.currentShop.delivery_range = payload.delivery_range;
          this.currentShop.delivery_fee = payload.delivery_fee;
          this.currentShop.business_hours = payload.business_hours;
          this.shopProfileDialogVisible = false;
          ElementPlus.ElMessage.success('店铺资料已更新');
        } catch (e) {
          ElementPlus.ElMessage.error('店铺资料保存失败：' + e.message);
        }
      },
      // 订单状态文本
      statusText(s) {
        const map = {
          0: '未下单',
          1: '待支付',
          2: '待接单',
          3: '已自我取消',
          4: '待配送',
          5: '配送中',
          6: '已完成',
          7: '已被商家取消',
          8: '备餐中'
        };
        return map[s] || '未知';
      },
      // 订单状态样式类
      statusClass(s) {
        return {
          'order-status-tag': true,
          'status-warn': [1,2,4,8].includes(s),
          'status-info': s === 5,
          'status-success': s === 6,
          'status-error': [3,7].includes(s)
        };
      },
      // 更新订单状态
      async setStatus(order, newStatus) {
        if (!order || !this.currentShop) return;

        this.operLoading = true;
        try {
          const orderId = order.order_id || order.OrderID;
          await this.request('/shop/updateorderstatus', {
            method: 'POST',
            body: JSON.stringify({
              OrderID: orderId,
              Status: newStatus
            })
          });

          // 刷新订单
          await this.loadOrders();
          ElementPlus.ElMessage.success(`已将订单 #${orderId} 状态改为：${this.statusText(newStatus)}`);
        } catch (e) {
          ElementPlus.ElMessage.error('状态更新失败：' + e.message);
        } finally {
          this.operLoading = false;
        }
      },
      // 标记备餐完成
      async markWaitingForDelivery(order) {
        if (!order) return;
        this.operLoading = true;
        try {
          const orderId = order.order_id || order.OrderID || order.id;
          await this.request('/shop/watingfordeliveryorder', {
            method: 'POST',
            body: JSON.stringify({ OrderID: orderId })
          });
          await this.loadOrders();
          ElementPlus.ElMessage.success(`已标记备餐完成 #${orderId}`);
        } catch (e) {
          ElementPlus.ElMessage.error('操作失败：' + e.message);
        } finally {
          this.operLoading = false;
        }
      },
      // 拒单（商家）
      async refuseOrder(order) {
        if (!order || !this.currentShop) return;
        this.operLoading = true;
        try {
          const orderId = order.order_id || order.OrderID || order.id;
          const shopId = this.currentShop.shop_id || this.currentShop.ShopID;
          await this.request('/shop/refuseorderbyshop', {
            method: 'POST',
            body: JSON.stringify({ order_id: orderId, shop_id: shopId })
          });
          await this.loadOrders();
          ElementPlus.ElMessage.success(`已拒单 #${orderId}`);
        } catch (e) {
          ElementPlus.ElMessage.error('拒单失败：' + e.message);
        } finally {
          this.operLoading = false;
        }
      },
      // 接单
      async acceptOrder(order) {
        if (!order) return;
        this.operLoading = true;
        try {
          const orderId = order.order_id || order.OrderID || order.id;
          await this.request('/shop/acceptorder', {
            method: 'POST',
            body: JSON.stringify({ OrderID: orderId })
          });
          await this.loadOrders();
          ElementPlus.ElMessage.success(`已接单 #${orderId}`);
        } catch (e) {
          ElementPlus.ElMessage.error('接单失败：' + e.message);
        } finally {
          this.operLoading = false;
        }
      },
      // 刷新订单
      async refreshOrders() {
        await this.loadOrders();
        ElementPlus.ElMessage.success('订单已刷新');
      },
      // 刷新营收数据
      async refreshStats() {
        await this.loadOrders();
        ElementPlus.ElMessage.success('营收数据已刷新');
      },
      async canModifyMenu() {
        if (!this.currentShop) return false;
        const status = this.currentShop?.status || this.currentShop?.Status || (this.shopOpen ? 1 : 0);
        if (status === 0) return true;
        try {
          const data = await this.request(`/shop/getordersbyshopid?shop_id=${encodeURIComponent(this.currentShop.shop_id)}`);
          const list = Array.isArray(data) ? data : (data ? [data] : []);
          const hasActive = list.some(o => [1,2,4,8].includes(Number(o.status || o.Status)));
          if (hasActive) {
            await ElementPlus.ElMessageBox.alert('当前有订单进行中，无法修改菜单，请等待打烊后更改', '提示', { type: 'warning' });
            return false;
          }
          return true;
        } catch (e) {
          await ElementPlus.ElMessageBox.alert('订单状态校验失败，请稍后重试', '提示', { type: 'error' });
          return false;
        }
      },
      // 新增菜品
      async addDish() {
        const ok = await this.canModifyMenu();
        if (!ok) return;
        // 重置编辑表单
        this.editForm = {
          dish_id: null,
          shop_id: this.currentShop.shop_id,
          dish_name: '',
          price: 0,
          stock: 0,
          status: 1,
          menu_name: this.currentMenuName
        };
        this.editDialogVisible = true;
      },
      // 切换菜品状态
      async toggleDishStatus(dish) {
        if (!dish || !this.currentShop) return;
        const ok = await this.canModifyMenu();
        if (!ok) return;

        this.operLoading = true;
        try {
          const newStatus = dish.status === 1 ? 0 : 1;
          if (newStatus === 0) {
            await this.request('/shop/stopdish', {
              method: 'POST',
              body: JSON.stringify({ dish_id: dish.dish_id })
            });
          } else {
            await this.request('/shop/startdish', {
              method: 'POST',
              body: JSON.stringify({ dish_id: dish.dish_id })
            });
          }

          // 刷新菜品
          await this.loadDishesForMenu(this.selectedMenuId);
          ElementPlus.ElMessage.success(newStatus === 1 ? '菜品已上架' : '菜品已停售');
        } catch (e) {
          ElementPlus.ElMessage.error('菜品状态更新失败：' + e.message);
        } finally {
          this.operLoading = false;
        }
      },
      // 编辑菜品
      async editDish(dish) {
        const ok = await this.canModifyMenu();
        if (!ok) return;
        this.editForm = {
          dish_id: dish.dish_id,
          shop_id: dish.shop_id,
          dish_name: dish.dish_name,
          price: dish.price,
          stock: dish.stock,
          status: dish.status
        };
        this.editDialogVisible = true;
      },
      // 保存菜品编辑
      async saveDishEdit() {
        if (!this.currentShop) return;

        // 表单验证
        if (!this.editForm.dish_name.trim()) {
          ElementPlus.ElMessage.warning('菜名不能为空');
          return;
        }
        if (this.editForm.price < 0) {
          ElementPlus.ElMessage.warning('价格不能为负');
          return;
        }
        if (this.editForm.stock < 0) {
          ElementPlus.ElMessage.warning('库存不能为负');
          return;
        }

        this.operLoading = true;
        try {
          if (this.editForm.dish_id) {
            const body = {
              dish_id: this.editForm.dish_id,
              dish_name: this.editForm.dish_name.trim(),
              price: this.editForm.price,
              stock: this.editForm.stock,
              status: this.editForm.status
            };
            await this.request('/shop/savedish', {
              method: 'POST',
              body: JSON.stringify(body)
            });
          } else {
            const body = {
              dish_name: this.editForm.dish_name.trim(),
              price: this.editForm.price,
              stock: this.editForm.stock,
              status: this.editForm.status,
              shop_id: this.editForm.shop_id,
              menu_name: this.editForm.menu_name
            };
            if (!body.menu_name) {
              ElementPlus.ElMessage.warning('请选择所属菜单');
              this.operLoading = false;
              return;
            }
            await this.request('/shop/adddish', {
              method: 'POST',
              body: JSON.stringify(body)
            });
          }

          // 刷新菜品
          await this.loadDishesForMenu(this.selectedMenuId);
          this.editDialogVisible = false;
          ElementPlus.ElMessage.success(this.editForm.dish_id ? '菜品已更新' : '菜品已新增');
        } catch (e) {
          ElementPlus.ElMessage.error('菜品保存失败：' + e.message);
        } finally {
          this.operLoading = false;
        }
      },
      // 数字格式化（兼容字符串/数字）
      formatNumber(val) {
        if (val === undefined || val === null) return 0;
        const num = typeof val === 'string' ? parseFloat(val) : Number(val);
        return isNaN(num) ? 0 : num;
      }
    }
  };

  const app = Vue.createApp(App);
  app.use(ElementPlus);
  // 注册所有 Element Plus 图标
  for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
    app.component(key, component);
  }
  app.mount('#app');
</script>
</body>
</html>
