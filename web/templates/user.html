<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>饭团外卖风格 - 智能点餐</title>
    <link rel="shortcut icon" href="#">
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #00cbd3;
            --primary-dark: #00b5bc;
            --bg-color: #f7f8fa;
            --text-main: #333333;
            --text-sub: #999999;
            --border-color: #eeeeee;
        }

        body {
            margin: 0;
            font-family: 'Noto Sans SC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden; /* 防止双重滚动条 */
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* --- Header --- */
        .app-header {
            height: 72px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            flex-shrink: 0;
            z-index: 100;
        }
        .header-left, .header-right { display: flex; align-items: center; gap: 20px; }
        
        .brand-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: 900;
            cursor: pointer;
        }
        .brand-logo-icon {
            background: var(--primary-color);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .location-selector {
            display: flex; align-items: center; gap: 8px; font-weight: bold; cursor: pointer;
        }
        .search-bar { flex: 1; max-width: 500px; margin: 0 40px; }
        .el-input__wrapper { border-radius: 24px !important; background-color: #f2f4f7 !important; padding: 4px 15px !important; box-shadow: none !important; }

        /* 用户下拉菜单样式 */
        .user-dropdown-link {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .user-dropdown-link:hover {
            background: #f5f5f5;
        }

        /* --- Main Container --- */
        .main-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px 40px;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        /* --- Home View Styles --- */
        .category-nav { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .cat-item { display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer; opacity: 0.8; transition: 0.2s; }
        .cat-item:hover, .cat-item.active { opacity: 1; transform: translateY(-2px); }
        .cat-icon { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; }
        
        .filter-bar { display: flex; gap: 12px; margin-bottom: 24px; }
        .filter-tag { background: white; border: 1px solid #ddd; padding: 6px 16px; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; }
        .filter-tag.active { background: #e0fbf9; color: var(--primary-color); border-color: var(--primary-color); }

        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
        .shop-card { background: white; border-radius: 12px; overflow: hidden; cursor: pointer; transition: 0.2s; }
        .shop-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .shop-img-wrapper { height: 160px; position: relative; }
        .shop-img { width: 100%; height: 100%; object-fit: cover; }
        .shop-info { padding: 16px; }

        /* --- Menu View Styles --- */
        .menu-layout { display: flex; height: 100%; overflow: hidden; margin: -24px -40px; } /* 抵消 main padding */
        .menu-main { flex: 1; overflow-y: auto; padding: 20px 40px; background: #f7f8fa; }
        .menu-cart-sidebar { width: 360px; background: white; border-left: 1px solid #eee; display: flex; flex-direction: column; }

        /* --- Order History Styles --- */
        .order-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
            border: 1px solid #f0f0f0;
            transition: all 0.3s;
        }
        .order-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f5f5f5;
            padding-bottom: 12px;
            margin-bottom: 12px;
        }
        .order-shop-name { font-weight: 900; font-size: 18px; display: flex; align-items: center; gap: 8px; }
        
        .order-status { font-size: 14px; font-weight: bold; padding: 4px 10px; border-radius: 4px; background: #f5f5f5; color: #999; }
        .order-status.completed { background: #e0fbf9; color: var(--primary-color); }
        .order-status.pending { background: #fff7e6; color: #fa8c16; }
        .order-status.cancelled { background: #fff1f0; color: #ff4d4f; }
        
        .order-dishes {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .order-dish-item {
            flex-shrink: 0;
            width: 80px;
            text-align: center;
            font-size: 12px;
        }
        .order-dish-img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: #f5f5f5;
            margin: 0 auto 4px;
            object-fit: cover;
        }
        
        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #666;
        }
        .order-price { font-size: 18px; font-weight: bold; color: #333; }

        /* Overrides */
        .el-button--primary { --el-button-bg-color: var(--primary-color); --el-button-border-color: var(--primary-color); }
        .el-button--primary:hover { --el-button-bg-color: var(--primary-dark); --el-button-border-color: var(--primary-dark); }
        .address-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .address-item:hover { background: #f9f9f9; }
        .address-item.selected { color: var(--primary-color); font-weight: bold; background: #e0fbf9; }
        
        /* Dropdown custom */
        .el-dropdown-menu__item:not(.is-disabled):focus { background-color: #e0fbf9; color: var(--primary-color); }
    </style>
</head>
<body>
    <div id="app">
        <!-- 登录弹窗 -->
        <div v-if="!currentUser" style="position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:999;display:flex;justify-content:center;align-items:center;">
            <div style="background:white;padding:40px;border-radius:16px;width:400px;text-align:center;">
                <div class="brand-logo" style="justify-content:center;margin-bottom:20px;">
                    <div class="brand-logo-icon"><el-icon><food /></el-icon></div>
                    <span>饭团外卖</span>
                </div>
                <h3 style="color:#666;margin-bottom:20px;">账号登录</h3>
                <el-form :model="loginForm" @submit.prevent="handleLogin">
                    <el-form-item><el-input v-model="loginForm.username" placeholder="用户名" :prefix-icon="User" size="large"/></el-form-item>
                    <el-form-item><el-input v-model="loginForm.password" type="password" placeholder="密码" :prefix-icon="Lock" show-password size="large"/></el-form-item>
                    <el-button type="primary" style="width:100%;border-radius:20px;" size="large" :loading="loading" @click="handleLogin">登录 / 注册</el-button>
                </el-form>
                <div style="margin-top:15px;color:#999;font-size:12px;">演示账号: admin / admin</div>
            </div>
        </div>

        <!-- 地址选择弹窗 -->
        <el-dialog v-model="locationDialogVisible" title="选择收货地址" width="400px">
            <div v-for="(addr, index) in mockAddresses" :key="index" class="address-item" :class="{selected: currentAddress===addr}" @click="selectAddress(addr)">
                <div style="display:flex;align-items:center;gap:8px;">
                    <el-icon><location /></el-icon><span>{{ addr }}</span>
                </div>
            </div>
            <div style="padding:10px;text-align:center;color:#999;cursor:pointer;" @click="addNewAddress"><el-icon><plus /></el-icon> 新增地址</div>
        </el-dialog>

        <!-- Header -->
        <header v-if="currentUser" class="app-header">
            <div class="header-left">
                <div class="brand-logo" @click="backToHome">
                    <div class="brand-logo-icon"><el-icon><food /></el-icon></div><span>饭团外卖</span>
                </div>
                <div class="location-selector" @click="locationDialogVisible=true">
                    <el-icon><location /></el-icon><span>{{ currentAddress }}</span><el-icon><arrow-down /></el-icon>
                </div>
            </div>
            <div class="search-bar">
                <el-input v-model="searchKeyword" prefix-icon="Search" placeholder="搜索商家..." clearable />
            </div>
            <div class="header-right">
                <!-- 用户头像下拉菜单 -->
                <el-dropdown trigger="click" @command="handleUserCommand">
                    <div class="user-dropdown-link">
                        <div style="text-align:right;line-height:1.2;">
                            <div style="font-weight:bold;color:#333;">{{ currentUser.username }}</div>
                            <div style="font-size:12px;color:#999;">SVIP会员</div>
                        </div>
                        <el-avatar :size="36" style="background:#e0fbf9;color:var(--primary-color);">{{ (currentUser.username||'U')[0] }}</el-avatar>
                        <el-icon style="color:#999"><caret-bottom /></el-icon>
                    </div>
                    <template #dropdown>
                        <el-dropdown-menu>
                            <el-dropdown-item command="orders" style="font-weight:bold;">
                                <el-icon><tickets /></el-icon>我的订单
                            </el-dropdown-item>
                            <el-dropdown-item divided command="logout" style="color:#f56c6c;">
                                <el-icon><switch-button /></el-icon>退出登录
                            </el-dropdown-item>
                        </el-dropdown-menu>
                    </template>
                </el-dropdown>
            </div>
        </header>

        <!-- Main Content Switcher -->
        <div v-if="currentUser" class="main-container" :style="currentShopId ? 'padding:0;max-width:100%;' : ''">
            
            <!-- 1. 订单列表页 (Order History) -->
            <div v-if="showOrderHistory" style="max-width:800px;margin:0 auto;padding-top:20px;">
                <div style="margin-bottom:20px;display:flex;align-items:center;gap:10px;">
                    <el-button circle @click="closeOrderList"><el-icon><back /></el-icon></el-button>
                    <h2 style="margin:0;">我的订单</h2>
                </div>
                
                <div v-loading="loadingOrders">
                    <div v-if="orders.length === 0" style="text-align:center;padding:60px;color:#999;">
                        <el-icon size="60"><tickets /></el-icon>
                        <p>暂无订单记录</p>
                        <el-button type="primary" @click="closeOrderList">去点餐</el-button>
                    </div>

                    <div v-for="order in orders" :key="order.order_id || order.id" class="order-card">
                        <div class="order-header">
                            <div class="order-shop-name">
                                <span>{{ order.shop_name || '未知商家' }}</span>
                                <el-icon><arrow-right /></el-icon>
                            </div>
                            <!-- 状态显示：根据 status 动态变化样式 -->
                            <span class="order-status" 
                                  :class="{
                                      'completed': order.status === '已完成',
                                      'pending': ['准备中', '待接单', '配送中'].includes(order.status),
                                      'cancelled': order.status === '已取消'
                                  }">
                                {{ order.status || '准备中' }}
                            </span>
                        </div>
                        
                        <!-- 菜品缩略图展示 -->
                        <div class="order-dishes" v-if="order.dishes && order.dishes.length">
                            <div v-for="dish in order.dishes" :key="dish.id" class="order-dish-item">
                                <img :src="dish.image || 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?ixlib=rb-1.2.1&auto=format&fit=crop&w=100&q=60'" class="order-dish-img">
                                <div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{{ dish.name }}</div>
                            </div>
                        </div>
                        <div v-else style="color:#999;font-size:14px;margin-bottom:10px;">
                           共 {{ order.item_count || 1 }} 件商品
                        </div>

                        <div class="order-footer">
                            <span>{{ order.create_time || '刚刚' }}</span>
                            <div>
                                <span style="margin-right:10px;">总计</span>
                                <span class="order-price">¥{{ order.total_price }}</span>
                            </div>
                        </div>
                        <div style="text-align:right;margin-top:15px;border-top:1px solid #f9f9f9;padding-top:10px;">
                            <!-- 取消订单按钮：仅在特定状态下显示 -->
                            <el-button 
                                v-if="['准备中', '待接单', '配送中'].includes(order.status || '准备中')" 
                                size="small" 
                                type="danger" 
                                plain 
                                @click="cancelOrder(order)"
                            >取消订单</el-button>
                            <el-button size="small">联系商家</el-button>
                            <el-button type="primary" size="small" plain>再来一单</el-button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. 店铺列表页 (Home) -->
            <div v-else-if="!currentShopId">
                <div class="category-nav">
                    <!-- 修复1：传参改为 cat.type_id 而非 cat.keyword -->
                    <div class="cat-item" v-for="cat in categories" :class="{active: currentCategory===cat.name}" @click="handleCategoryClick(cat.name, cat.type_id)">
                        <div class="cat-icon" :style="{background:cat.color}"><el-icon><component :is="cat.icon" /></el-icon></div>
                        <div class="cat-text">{{cat.name}}</div>
                    </div>
                </div>
                <div class="filter-bar">
                    <div class="filter-tag" :class="{active: currentSort==='default'}" @click="handleSort('default')">综合排序</div>
                    <div class="filter-tag" :class="{active: currentSort==='distance'}" @click="handleSort('distance')">距离最近</div>
                    <div class="filter-tag" :class="{active: currentSort==='price'}" @click="handleSort('price')">配送费最低</div>
                </div>
                <div class="shop-grid" v-loading="loadingShops">
                    <div v-for="shop in computedShops" :key="shop.shop_id" class="shop-card" @click="handleSelectShop(shop)">
                        <div class="shop-img-wrapper">
                            <img :src="shop.image || 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60'" class="shop-img" :style="shop.status!==1?'filter:grayscale(1)':''">
                            <div v-if="shop.status===1" style="position:absolute;top:0;left:0;background:#00cbd3;color:white;font-size:12px;padding:2px 6px;border-bottom-right-radius:8px;">新客减10</div>
                            <div v-if="shop.status!==1" style="position:absolute;inset:0;background:rgba(255,255,255,0.7);display:flex;justify-content:center;align-items:center;font-weight:bold;color:#666;">休息中</div>
                        </div>
                        <div class="shop-info">
                            <div style="font-weight:900;font-size:16px;margin-bottom:6px;">{{ shop.shop_name }}</div>
                            <div style="font-size:12px;color:#666;display:flex;align-items:center;gap:10px;">
                                <span style="color:#ffaa00;font-weight:bold;"><el-icon><star-filled /></el-icon> 4.8</span>
                                <span>{{ (shop.delivery_range||0).toFixed(1) }}km</span>
                                <span>配送 ¥{{ (shop.delivery_fee||0).toFixed(0) }}</span>
                            </div>
                        </div>
                    </div>
                    <el-empty v-if="computedShops.length===0" description="未找到相关商家"></el-empty>
                </div>
            </div>

            <!-- 3. 点餐页 (Menu) -->
            <div v-else class="menu-layout">
                <main class="menu-main" v-loading="loadingMenu">
                    <div style="margin-bottom:20px;display:flex;align-items:center;gap:10px;">
                        <el-button circle @click="backToHome"><el-icon><back /></el-icon></el-button>
                        <h2 style="margin:0;">{{ currentShopName }}</h2>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));gap:15px;">
                        <div v-for="dish in menuItems" :key="dish.id" style="background:white;border-radius:8px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,0.05);display:flex;flex-direction:column;">
                            <img :src="dish.image||'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=60'" style="height:140px;object-fit:cover;">
                            <div style="padding:10px;flex:1;display:flex;flex-direction:column;">
                                <!-- 修复菜品名称显示：直接使用 dish.name -->
                                <div style="font-weight:bold;">{{ dish.name }}</div>
                                <div style="font-size:12px;color:#999;margin:5px 0 10px;flex:1;">{{ dish.description||'暂无描述' }}</div>
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <span style="color:#ff4d4f;font-weight:bold;">¥{{ dish.price }}</span>
                                    <el-button type="primary" circle size="small" @click="addToCart(dish)"><el-icon><plus /></el-icon></el-button>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
                <aside class="menu-cart-sidebar">
                    <div style="padding:15px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-weight:bold;">购物车 ({{ cart.length }})</span>
                        <el-button link type="danger" @click="clearCart" :disabled="cart.length===0">清空</el-button>
                    </div>
                    <div style="flex:1;overflow-y:auto;padding:15px;">
                        <div v-if="cart.length===0" style="text-align:center;color:#ccc;margin-top:50px;">
                            <el-icon size="40"><shopping-cart /></el-icon><p>空空如也</p>
                        </div>
                        <div v-for="item in cart" :key="item.id" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                            <div><div style="font-weight:bold;">{{ item.name }}</div><div style="font-size:12px;color:#999;">¥{{ item.price }}</div></div>
                            <div style="display:flex;align-items:center;gap:5px;">
                                <el-button size="small" circle @click="decreaseQuantity(item)">-</el-button><span>{{ item.quantity }}</span><el-button size="small" circle type="primary" @click="increaseQuantity(item)">+</el-button>
                            </div>
                        </div>
                    </div>
                    <div style="padding:20px;border-top:1px solid #eee;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:15px;font-size:20px;font-weight:bold;"><span>合计</span><span>¥{{ cartTotal }}</span></div>
                        <el-button type="primary" style="width:100%;height:44px;border-radius:22px;font-size:16px;" :disabled="cart.length===0" @click="submitOrder" :loading="submitting">去结算</el-button>
                    </div>
                </aside>
            </div>

        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;
        const { User, Lock, Food, Shop, Plus, ShoppingCart, Search, StarFilled, SwitchButton, Location, ArrowDown, Back, ArrowRight, Tickets, Ticket, Present, ShoppingBag, Burger, Bowl, IceCream, CaretBottom } = ElementPlusIconsVue;

        // --- 配置 ---
        // 关键修改1：关闭模拟数据，改为对接真实接口
        const USE_MOCK_DATA = false; 

        // --- Mock Data ---
        // 关键修改2：保留Mock数据（备用），但实际不会触发
        const MOCK_SHOPS = [
            { shop_id: 1, shop_name: '菇的辣克 Good Luck', status: 1, delivery_fee: 0, delivery_range: 5.6, type: 3 }, 
            { shop_id: 2, shop_name: '韩餐 Hodori', status: 1, delivery_fee: 5, delivery_range: 2.3, type: 3 }, 
            { shop_id: 3, shop_name: '蜜雪冰城', status: 1, delivery_fee: 2, delivery_range: 3.0, type: 1 }, 
            { shop_id: 4, shop_name: '麦当劳', status: 1, delivery_fee: 0, delivery_range: 4.0, type: 2 }, 
            { shop_id: 5, shop_name: '便利店', status: 1, delivery_fee: 3, delivery_range: 2.0, type: 4 } 
        ];
        const MOCK_MENU = { 
            1: [{ id: 101, name: '招牌辣子鸡', price: 28 }], 
            2: [{ id: 201, name: '石锅拌饭', price: 18 }],
            3: [{ id: 301, name: '珍珠奶茶', price: 12 }],
            4: [{ id: 401, name: '巨无霸', price: 24 }],
            5: [{ id: 501, name: '矿泉水', price: 2 }]
        };
        const MOCK_ORDERS = [
            { order_id: 'ORD-123', shop_name: '菇的辣克 Good Luck', status: '已完成', total_price: 56, create_time: '2023-10-01 12:00', dishes: [{name: '招牌辣子鸡', image: null}] },
            { order_id: 'ORD-124', shop_name: '韩餐 Hodori', status: '配送中', total_price: 36, create_time: '2023-10-02 18:30', dishes: [{name: '石锅拌饭', image: null}] },
            { order_id: 'ORD-125', shop_name: '必胜客 Pizza', status: '准备中', total_price: 88, create_time: '2023-10-02 19:00', dishes: [{name: '超级至尊披萨', image: null}] }
        ];

        const app = createApp({
            components: { User, Lock, Food, Shop, Plus, ShoppingCart, Search, StarFilled, SwitchButton, Location, ArrowDown, Back, ArrowRight, Tickets, CaretBottom },
            setup() {
                const currentUser = ref(null);
                const loginForm = reactive({ username: '', password: '' });
                const loading = ref(false);
                const shops = ref([]); // 存储后端返回的店铺数据
                const loadingShops = ref(false);
                const menuItems = ref([]);
                const loadingMenu = ref(false);
                const currentShopId = ref(null);
                const currentShopName = ref('');
                const cart = ref([]);
                const submitting = ref(false);
                
                // 订单相关
                const showOrderHistory = ref(false);
                const orders = ref([]);
                const loadingOrders = ref(false);

                // 筛选与定位
                const searchKeyword = ref('');
                const currentCategory = ref('全部');
                const currentType = ref(0); 
                const currentSort = ref('default');
                const locationDialogVisible = ref(false);
                const currentAddress = ref('233 N Spring St, Los Angeles');
                const mockAddresses = ref(['233 N Spring St, Los Angeles', 'USC Village', 'Santa Monica Blvd']);

                const categories = [
                    { name: '全部', type_id: 0, icon: 'Food', color: '#ff6b6b' },
                    { name: '甜品奶茶', type_id: 1, icon: 'IceCream', color: '#ff9f43' },
                    { name: '炸鸡汉堡', type_id: 2, icon: 'Burger', color: '#feca57' },
                    { name: '美味中餐', type_id: 3, icon: 'Bowl', color: '#ee5253' },
                    { name: '生活百货', type_id: 4, icon: 'ShoppingBag', color: '#5f27cd' },
                ];

                // 登录
                const handleLogin = () => {
                    loading.value = true;
                    if (USE_MOCK_DATA) {
                        setTimeout(() => { currentUser.value = { id: 888, username: 'Admin' }; loading.value = false; fetchShops(); }, 500);
                    } else {
                        // 对接真实登录接口（需后端实现）
                        fetch('/user/login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(loginForm) })
                        .then(res => { if(!res.ok) throw new Error(); return res.json(); })
                        .then(data => { currentUser.value = data; fetchShops(); })
                        .catch(() => ElMessage.error('登录失败'))
                        .finally(() => loading.value = false);
                    }
                };

                // 下拉菜单处理
                const handleUserCommand = (cmd) => {
                    if (cmd === 'orders') openOrderList();
                    if (cmd === 'logout') logout();
                };

                const logout = () => {
                    if (cart.value.length > 0) {
                        ElMessageBox.confirm('购物车不为空，退出将清空购物车，确定吗？', '提示', { confirmButtonText: '确定', cancelButtonText: '取消', type: 'warning' })
                        .then(() => { performLogout(); }).catch(()=>{});
                    } else {
                        performLogout();
                    }
                };

                const performLogout = () => {
                    currentUser.value = null; cart.value = []; currentShopId.value = null; showOrderHistory.value = false;
                };

                // 商家 & 菜单
                const fetchShops = () => {
                    loadingShops.value = true;
                    if (USE_MOCK_DATA) { 
                        setTimeout(() => { shops.value = MOCK_SHOPS; loadingShops.value = false; }, 300); 
                    } else {
                        // 关键修改3：调用后端/shop/getall接口，获取真实店铺数据
                        fetch('/shop/getall', { 
                            method: 'POST', 
                            headers: {'Content-Type':'application/json'},
                            // 如需传参（如token/地址），可在这里添加body
                            // body: JSON.stringify({ token: currentUser.value.token })
                        })
                        .then(res => {
                            if (!res.ok) throw new Error('接口请求失败');
                            return res.json();
                        })
                        .then(data => {
                            // 确保后端返回的是数组，且字段和前端匹配（shop_id, shop_name, status, delivery_fee, delivery_range, type）
                            shops.value = Array.isArray(data) ? data : [];
                        })
                        .catch(()=>ElMessage.error('获取商家失败'))
                        .finally(()=>loadingShops.value=false);
                    }
                };

                const fetchMenu = (shopId) => {
                    loadingMenu.value = true;
                    if (USE_MOCK_DATA) {
                        setTimeout(() => { menuItems.value = (MOCK_MENU[shopId]||[]).map(normalizeDish); loadingMenu.value = false; }, 300);
                    } else {
                        // 对接真实菜单接口（需后端实现）
                        fetch('/menudish/getallmenudishes', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({shop_id: shopId}) })
                        .then(res => res.json()).then(res => menuItems.value = (res.data||[]).map(normalizeDish))
                        .catch(()=>ElMessage.error('获取菜单失败')).finally(()=>loadingMenu.value=false);
                    }
                };

                const normalizeDish = (item) => {
                    const id = item.dish_id ?? item.dishId ?? item.id ?? item.MenuID;
                    const name = item.dish_name ?? item.dishName ?? item.DishName ?? item.name ?? item.MenuName ?? (id ? `菜品#${id}` : '未知菜品');
                    const price = item.price ?? item.Price ?? 0;
                    return { id, name, price, description: item.description||'', image: item.image||null, shop_id: item.shop_id };
                };

                // 交互
                const handleSelectShop = (shop) => {
                    if(shop.status!==1) ElMessage.warning('商家休息中');
                    if(cart.value.length>0 && currentShopId.value!==shop.shop_id) {
                        ElMessageBox.confirm('切换商家将清空购物车，确定？', '提示', {confirmButtonText:'确定',cancelButtonText:'取消',type:'warning'})
                        .then(()=>{ cart.value=[]; switchToShop(shop); }).catch(()=>{});
                    } else { switchToShop(shop); }
                };
                const switchToShop = (shop) => { currentShopId.value = shop.shop_id; currentShopName.value = shop.shop_name; fetchMenu(shop.shop_id); };
                const backToHome = () => {
                    if(cart.value.length>0) {
                        ElMessageBox.confirm('返回首页将清空购物车，确定？', '提示', {confirmButtonText:'确定',cancelButtonText:'取消',type:'warning'})
                        .then(()=>{ cart.value=[]; currentShopId.value=null; showOrderHistory.value=false; }).catch(()=>{});
                    } else { currentShopId.value=null; showOrderHistory.value=false; }
                };

                // 购物车 & 订单
                const addToCart = (dish) => {
                    const exist = cart.value.find(i=>i.id===dish.id);
                    if(exist) exist.quantity++; else cart.value.push({...dish, quantity:1});
                    ElMessage.success(`已添加 ${dish.name}`);
                };
                const increaseQuantity = (i) => i.quantity++;
                const decreaseQuantity = (i) => { i.quantity--; if(i.quantity<=0) cart.value=cart.value.filter(x=>x.id===i.id); };
                const clearCart = () => {
                     ElMessageBox.confirm('确定清空购物车？', '提示', {confirmButtonText:'确定',cancelButtonText:'取消',type:'warning'})
                     .then(()=>{cart.value=[]}).catch(()=>{});
                };
                const cartTotal = computed(() => cart.value.reduce((s,i)=>s+i.price*i.quantity,0).toFixed(2));

                const submitOrder = () => {
                    if(cart.value.length===0) return;
                    submitting.value = true;
                    const payload = { user_id: currentUser.value.id, dishes: cart.value.map(i=>({id:i.id, quantity:i.quantity})) };
                    
                    const finish = () => {
                        ElMessageBox.confirm('订单提交成功！是否查看订单？', '成功', { confirmButtonText: '查看订单', cancelButtonText: '继续点餐', type: 'success' })
                        .then(() => { cart.value=[]; openOrderList(); })
                        .catch(() => { cart.value=[]; currentShopId.value=null; });
                        submitting.value = false;
                    };

                    if(USE_MOCK_DATA) { setTimeout(finish, 800); }
                    else {
                        fetch('/api/orders', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) })
                        .then(res=>res.json()).then(finish).catch(()=>ElMessage.error('提交失败')).finally(()=>submitting.value=false);
                    }
                };

                // --- 订单历史逻辑 ---
                const openOrderList = () => {
                    showOrderHistory.value = true;
                    currentShopId.value = null; 
                    fetchOrderList();
                };
                const closeOrderList = () => {
                    showOrderHistory.value = false;
                };
                const fetchOrderList = () => {
                    loadingOrders.value = true;
                    if(USE_MOCK_DATA) {
                        setTimeout(() => { orders.value = MOCK_ORDERS; loadingOrders.value = false; }, 500);
                    } else {
                        fetch('/order/getall', { 
                            method: 'POST', 
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify({ user_id: currentUser.value.id })
                        })
                        .then(res => res.json())
                        .then(data => { orders.value = Array.isArray(data) ? data : []; })
                        .catch(() => ElMessage.error('获取订单列表失败'))
                        .finally(() => loadingOrders.value = false);
                    }
                };
                
                // 取消订单逻辑
                const cancelOrder = (order) => {
                    ElMessageBox.confirm('确定要取消此订单吗？', '取消订单', {
                        confirmButtonText: '确定取消',
                        cancelButtonText: '点错了',
                        type: 'warning'
                    }).then(() => {
                        if (USE_MOCK_DATA) {
                            order.status = '已取消';
                            ElMessage.success('订单已取消');
                        } else {
                            const orderId = order.order_id || order.id; 
                            fetch('/api/orders/cancel', {
                                method: 'POST',
                                headers: {'Content-Type':'application/json'},
                                body: JSON.stringify({ order_id: orderId })
                            })
                            .then(res => {
                                if (res.ok) {
                                    order.status = '已取消'; 
                                    ElMessage.success('订单已取消');
                                } else {
                                    ElMessage.error('取消失败，请联系商家');
                                }
                            })
                            .catch(() => ElMessage.error('网络错误'));
                        }
                    }).catch(() => {});
                };

                // 筛选逻辑
                const handleCategoryClick = (n, typeId) => { 
                    currentCategory.value = n; 
                    currentType.value = typeId; 
                };
                const handleSort = (t) => currentSort.value=t;
                const computedShops = computed(() => {
                    let res = [...shops.value];
                    // 关键词筛选
                    if(searchKeyword.value) res = res.filter(s=>s.shop_name.includes(searchKeyword.value));
                    // 分类筛选
                    if(currentType.value !== 0) res = res.filter(s=>s.type === currentType.value);
                    // 排序
                    if(currentSort.value==='distance') res.sort((a,b)=>(a.delivery_range||0)-(b.delivery_range||0));
                    if(currentSort.value==='price') res.sort((a,b)=>(a.delivery_fee||0)-(b.delivery_fee||0));
                    return res;
                });
                
                // 地址逻辑
                const selectAddress = (addr) => { currentAddress.value=addr; locationDialogVisible.value=false; ElMessage.success('已切换地址'); };
                const addNewAddress = () => {
                    ElMessageBox.prompt('请输入新地址', '新增', {confirmButtonText:'确定',cancelButtonText:'取消'}).then(({value})=>{ if(value){ mockAddresses.value.unshift(value); selectAddress(value); }});
                };

                return {
                    currentUser, loginForm, loading, handleLogin, logout, handleUserCommand,
                    shops, loadingShops, computedShops, currentShopId, currentShopName, handleSelectShop, backToHome,
                    menuItems, loadingMenu, addToCart, cart, cartTotal, increaseQuantity, decreaseQuantity, clearCart, submitOrder, submitting,
                    categories, searchKeyword, currentCategory, handleCategoryClick, currentSort, handleSort,
                    locationDialogVisible, currentAddress, mockAddresses, selectAddress, addNewAddress,
                    showOrderHistory, orders, loadingOrders, openOrderList, closeOrderList, cancelOrder,
                    User, Lock,
                };
            }
        });

        app.use(ElementPlus);
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) { app.component(key, component) }
        app.component('IceCream', ElementPlusIconsVue.IceCream);
        app.component('Burger', ElementPlusIconsVue.Burger);
        app.component('Bowl', ElementPlusIconsVue.Bowl);
        app.component('ShoppingBag', ElementPlusIconsVue.ShoppingBag);
        app.mount('#app');
    </script>
</body>
</html>