<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能点餐系统 - 用户端</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>

    <style>
        body { margin: 0; background-color: #f5f7fa; font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', Arial, sans-serif; }
        .app-container { height: 100vh; display: flex; flex-direction: column; }
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: #2d3a4b; }
        .login-card { width: 400px; padding: 20px; }
        .header { background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 10; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; height: 60px; }
        .main-layout { height: calc(100vh - 60px); }
        .shop-list-aside { background: #fff; border-right: 1px solid #e6e6e6; overflow-y: auto; }
        .menu-main { padding: 20px; overflow-y: auto; background-color: #f5f7fa; }
        .cart-aside { background: #fff; border-left: 1px solid #e6e6e6; display: flex; flex-direction: column; box-shadow: -2px 0 5px rgba(0,0,0,0.05); }
        .cart-items { flex: 1; overflow-y: auto; padding: 10px; }
        .cart-footer { padding: 20px; border-top: 1px solid #ebeef5; background: #fff; }
        
        /* 自定义滚动条 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        
        .shop-card { cursor: pointer; transition: all 0.3s; margin-bottom: 10px; border: 1px solid transparent; }
        .shop-card:hover { transform: translateY(-2px); box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1); }
        .shop-card.active { border-color: #409EFF; background-color: #ecf5ff; }
        .shop-card.disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }

        .dish-card { height: 100%; display: flex; flex-direction: column; justify-content: space-between; }
        .dish-price { color: #f56c6c; font-size: 18px; font-weight: bold; }
        
        .empty-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #909399; }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="!currentUser" class="login-container">
            <el-card class="login-card">
                <template #header>
                    <h2 style="text-align: center; margin: 0; color: #333;">系统登录</h2>
                </template>
                <el-form :model="loginForm" @submit.prevent="handleLogin">
                    <el-form-item>
                        <el-input v-model="loginForm.username" placeholder="用户名" prefix-icon="User" size="large"></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-input v-model="loginForm.password" type="password" placeholder="密码" prefix-icon="Lock" size="large" show-password></el-input>
                    </el-form-item>
                    <el-button type="primary" style="width: 100%; margin-top: 10px;" size="large" @click="handleLogin" :loading="loading">
                        登 录
                    </el-button>
                </el-form>
                <div v-if="loginError" style="color: #f56c6c; margin-top: 10px; text-align: center;">{{ loginError }}</div>
            </el-card>
        </div>

        <div v-else class="app-container">
            <header class="header">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <el-icon size="24" color="#409EFF"><Food /></el-icon>
                    <h2 style="margin: 0; font-size: 20px;">在线点餐系统</h2>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <el-tag effect="dark" type="success">用户: {{ currentUser.username || 'Admin' }}</el-tag>
                    <el-button type="danger" link @click="logout">退出</el-button>
                </div>
            </header>

            <el-container class="main-layout">
                <el-aside width="300px" class="shop-list-aside">
                    <div style="padding: 15px; border-bottom: 1px solid #eee;">
                        <h3 style="margin: 0;">商家列表</h3>
                    </div>
                    <div v-loading="loadingShops" style="padding: 10px;">
                        <el-empty v-if="shops.length === 0 && !loadingShops" description="暂无商家"></el-empty>
                        
                        <el-card 
                            v-for="shop in shops" 
                            :key="shop.shop_id" 
                            shadow="hover" 
                            class="shop-card"
                            :class="{ 
                                'active': currentShopId === shop.shop_id, 
                                'disabled': isShopDisabled(shop) 
                            }"
                            @click="handleSelectShop(shop)"
                        >
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <span style="font-weight: bold; font-size: 16px;">{{ shop.shop_name }}</span>
                                <el-tag size="small" :type="shop.status === 1 ? 'success' : 'info'">
                                    {{ shop.status === 1 ? '营业中' : '休息中' }}
                                </el-tag>
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 8px; line-height: 1.6;">
                                <div>配送: ¥{{ (shop.delivery_fee || 0).toFixed(2) }} | {{ (shop.delivery_range || 0).toFixed(1) }}km</div>
                                <div>时间: {{ shop.business_hours }}</div>
                            </div>
                        </el-card>
                    </div>
                </el-aside>

                <el-main class="menu-main" v-loading="loadingMenu">
                    <div v-if="!currentShopId" class="empty-placeholder">
                        <el-icon size="60"><Shop /></el-icon>
                        <p>请从左侧选择一个商家开始点餐</p>
                    </div>
                    
                    <div v-else>
                        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="margin: 0;">{{ currentShopName }} - 菜单</h2>
                            <el-tag type="info">共 {{ menuItems.length }} 道菜品</el-tag>
                        </div>
                        
                        <el-row :gutter="20">
                            <el-col :xs="24" :sm="12" :md="8" :lg="6" v-for="dish in menuItems" :key="dish.id" style="margin-bottom: 20px;">
                                <el-card :body-style="{ padding: '0px' }" shadow="hover">
                                    <div style="padding: 14px;" class="dish-card">
                                        <div style="font-size: 16px; font-weight: bold; margin-bottom: 10px; height: 40px; overflow: hidden;">{{ dish.name }}</div>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span class="dish-price">¥{{ Number(dish.price).toFixed(2) }}</span>
                                            <el-button type="primary" circle size="small" @click="addToCart(dish)">
                                                <el-icon><Plus /></el-icon>
                                            </el-button>
                                        </div>
                                    </div>
                                </el-card>
                            </el-col>
                        </el-row>
                        <el-empty v-if="menuItems.length === 0" description="该商家暂无菜品"></el-empty>
                    </div>
                </el-main>

                <el-aside width="320px" class="cart-aside">
                    <div style="padding: 15px; border-bottom: 1px solid #eee; background: #fafafa; display: flex; align-items: center; justify-content: space-between;">
                        <h3 style="margin: 0;">当前订单</h3>
                        <el-button v-if="cart.length > 0" type="danger" link size="small" @click="clearCart">清空</el-button>
                    </div>
                    
                    <div class="cart-items">
                        <div v-if="cart.length === 0" class="empty-placeholder" style="height: 200px;">
                            <el-icon size="40"><ShoppingCart /></el-icon>
                            <p>购物车是空的</p>
                        </div>
                        
                        <div v-else>
                            <div v-if="currentShopId" style="font-size: 12px; color: #909399; margin-bottom: 10px; text-align: center;">
                                商家: {{ currentShopName }}
                            </div>
                            <div v-for="item in cart" :key="item.id" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500;">{{ item.name }}</div>
                                    <div style="color: #999; font-size: 12px;">¥{{ item.price }}</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <el-button circle size="small" @click="decreaseQuantity(item)">-</el-button>
                                    <span style="width: 20px; text-align: center;">{{ item.quantity }}</span>
                                    <el-button circle size="small" @click="increaseQuantity(item)">+</el-button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="cart-footer">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 18px; font-weight: bold;">
                            <span>总计:</span>
                            <span style="color: #f56c6c;">¥{{ cartTotal }}</span>
                        </div>
                        <el-button type="primary" size="large" style="width: 100%;" :disabled="cart.length === 0" @click="submitOrder" :loading="submitting">
                            立即结算
                        </el-button>
                    </div>
                </el-aside>
            </el-container>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;
        const { User, Lock, Food, Shop, Plus, ShoppingCart } = ElementPlusIconsVue;

        const app = createApp({
            components: {
                User, Lock, Food, Shop, Plus, ShoppingCart
            },
            setup() {
                // --- 状态数据 ---
                const currentUser = ref(null);
                const loginForm = reactive({ username: 'admin', password: 'admin' });
                const loginError = ref('');
                const loading = ref(false);
                
                const shops = ref([]);
                const loadingShops = ref(false);
                const menuItems = ref([]);
                const loadingMenu = ref(false);
                
                const currentShopId = ref(null);
                const currentShopName = ref('');
                const cart = ref([]);
                const submitting = ref(false);

                // --- 登录逻辑 ---
                const handleLogin = () => {
                    loading.value = true;
                    loginError.value = '';
                    fetch('/user/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(loginForm)
                    })
                    .then(res => {
                        if (!res.ok) throw new Error('登录失败');
                        return res.json();
                    })
                    .then(data => {
                        currentUser.value = data;
                        ElMessage.success('登录成功');
                        fetchShops();
                    })
                    .catch(() => {
                        loginError.value = '登录失败，请检查用户名和密码';
                    })
                    .finally(() => loading.value = false);
                };

                const logout = () => {
                    currentUser.value = null;
                    cart.value = [];
                    currentShopId.value = null;
                };

                // --- 商家逻辑 ---
                const fetchShops = () => {
                    loadingShops.value = true;
                    fetch('/shop/getall', {
                        method: 'POST', // 保持原有接口逻辑
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(res => {
                        if (!res.ok) throw new Error(res.status);
                        return res.json();
                    })
                    .then(data => {
                        shops.value = Array.isArray(data) ? data : [];
                    })
                    .catch(err => {
                        ElMessage.error('获取商家列表失败');
                        console.error(err);
                    })
                    .finally(() => loadingShops.value = false);
                };

                // 判断是否禁用商家（跨店拦截逻辑）
                const isShopDisabled = (shop) => {
                    // 如果购物车有东西，且当前商家不是购物车所属商家，则禁用
                    if (cart.value.length > 0 && currentShopId.value && shop.shop_id !== currentShopId.value) {
                        return true;
                    }
                    return false;
                };

                const handleSelectShop = (shop) => {
                    if (isShopDisabled(shop)) {
                        ElMessageBox.alert('当前有未提交的订单，请先提交或清空后再切换商家', '提示', { confirmButtonText: '确定' });
                        return;
                    }
                    if (shop.status !== 1) {
                        ElMessage.warning('该商家休息中，无法点餐');
                        // 可以选择是否允许查看菜单，这里暂时保留原有逻辑：休息中显示提示
                        // 但为了UI好看，我们可以允许点击，但在菜单区显示休息
                    }
                    
                    currentShopId.value = shop.shop_id;
                    currentShopName.value = shop.shop_name;
                    fetchMenu(shop.shop_id);
                };

                // --- 菜品逻辑 ---
                const fetchMenu = (shopId) => {
                    loadingMenu.value = true;
                    menuItems.value = [];
                    fetch('/menudish/getallmenudishes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ shop_id: shopId })
                    })
                    .then(res => {
                        if (!res.ok) throw new Error('加载菜品失败');
                        return res.json();
                    })
                    .then(res => {
                        const list = res.data || [];
                        menuItems.value = list.map(normalizeDish);
                    })
                    .catch(err => {
                        ElMessage.error('菜品加载失败');
                        console.error(err);
                    })
                    .finally(() => loadingMenu.value = false);
                };

                // 数据标准化工具函数（保留原有逻辑以适配各种奇葩Key）
                const normalizeDish = (item) => {
                    const id = item.dish_id ?? item.dishId ?? item.id ?? item.MenuID ?? item.menu_id ?? item.DishID ?? item.DishId;
                    const name = item.dish_name ?? item.dishName ?? item.DishName ?? item.name ?? item.MenuName ?? (id ? `菜品#${id}` : '菜品');
                    const price = item.price ?? item.Price ?? item.dish_price ?? item.dishPrice ?? 0;
                    const sId = item.shop_id ?? item.ShopID ?? item.shopId ?? item.ShopId ?? null;
                    return { id, name, price, shop_id: sId };
                };

                // --- 购物车逻辑 ---
                const addToCart = (dish) => {
                    // 绑定当前商家
                    if (cart.value.length === 0) {
                        // 确保当前选中的就是菜品所属的商家（UI逻辑已保证，但做个双保险）
                    }

                    const existing = cart.value.find(i => i.id === dish.id);
                    if (existing) {
                        existing.quantity++;
                    } else {
                        cart.value.push({ ...dish, quantity: 1 });
                    }
                    ElMessage.success({ message: `已添加: ${dish.name}`, duration: 1000 });
                };

                const increaseQuantity = (item) => item.quantity++;
                
                const decreaseQuantity = (item) => {
                    item.quantity--;
                    if (item.quantity <= 0) {
                        cart.value = cart.value.filter(i => i.id !== item.id);
                    }
                };

                const clearCart = () => {
                    ElMessageBox.confirm('确定要清空购物车吗?', '提示', { type: 'warning' })
                        .then(() => {
                            cart.value = [];
                            ElMessage.info('购物车已清空');
                        })
                        .catch(() => {});
                };

                const cartTotal = computed(() => {
                    return cart.value.reduce((sum, item) => sum + (item.price * item.quantity), 0).toFixed(2);
                });

                // --- 提交订单 ---
                const submitOrder = () => {
                    if (cart.value.length === 0) return;
                    
                    submitting.value = true;
                    const payload = {
                        user_id: currentUser.value && (currentUser.value.id ?? currentUser.value.user_id ?? currentUser.value.UserID),
                        dishes: cart.value.map(i => ({ id: i.id, quantity: i.quantity }))
                    };
                    
                    fetch('/api/orders', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    })
                    .then(res => res.json())
                    .then(data => {
                        ElMessageBox.alert(`订单已提交！订单号: ${data.order_id}`, '支付成功', {
                            confirmButtonText: '确定',
                            type: 'success',
                            callback: () => {
                                cart.value = []; // 清空购物车
                                // 这里不重置 currentShopId，方便用户继续在该店点餐，
                                // 或者你可以选择 currentShopId.value = null 回到列表
                            }
                        });
                    })
                    .catch(() => {
                        ElMessage.error('提交订单失败，请重试');
                    })
                    .finally(() => submitting.value = false);
                };

                return {
                    currentUser, loginForm, loading, loginError, handleLogin, logout,
                    shops, loadingShops, currentShopId, currentShopName, handleSelectShop, isShopDisabled,
                    menuItems, loadingMenu, addToCart,
                    cart, cartTotal, increaseQuantity, decreaseQuantity, clearCart, submitOrder, submitting
                };
            }
        });

        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>
