<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>点餐系统 - 顾客端</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .menu-section {
            flex: 2;
            min-width: 300px;
        }
        .order-section {
            flex: 1;
            min-width: 300px;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 5px;
        }
        .menu-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .menu-item h3 {
            margin: 0;
        }
        .category {
            margin-top: 30px;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .quantity-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: 50%;
        }
        .add-to-order {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 3px;
        }
        .submit-order {
            width: 100%;
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 15px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .remove-item {
            color: #f44336;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 5px;
            max-width: 500px;
            width: 100%;
        }
        .close-btn {
            float: right;
            font-size: 20px;
            cursor: pointer;
        }
        #order-status {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>点餐系统</h1>
    <div class="container">
        <div class="menu-section">
            <h2>菜单</h2>
            <div id="menu-container"></div>
        </div>
        <div class="order-section">
            <h2>您的订单</h2>
            <div id="order-items"></div>
            <div id="order-total"></div>
            <button class="submit-order" onclick="submitOrder()">提交订单</button>
            
            <div id="order-status"></div>
        </div>
    </div>
    
    <div class="modal" id="order-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modal-title">订单信息</h2>
            <p id="modal-message"></p>
            <button onclick="closeModal()">确定</button>
        </div>
    </div>

    <script>
        let menuItems = [];
        let orderItems = [];
        let tableNumber = '';
        let currentOrderId = null;
        let statusCheckInterval = null;

        // 初始化
        function init() {
            // 获取桌号
            fetch('/api/table/number')
                .then(response => response.json())
                .then(data => {
                    tableNumber = data.table_number;
                    document.querySelector('h1').textContent = `点餐系统 - 桌号: ${tableNumber}`;
                })
                .catch(error => console.error('获取桌号失败:', error));
                
            // 获取菜单
            fetch('/api/menu')
                .then(response => response.json())
                .then(data => {
                    menuItems = data;
                    renderMenu();
                })
                .catch(error => console.error('获取菜单失败:', error));
        }

        // 渲染菜单
        function renderMenu() {
            const menuContainer = document.getElementById('menu-container');
            menuContainer.innerHTML = '';
            
            // 按分类分组菜单
            const categories = {};
            menuItems.forEach(item => {
                if (!categories[item.category]) {
                    categories[item.category] = [];
                }
                if (item.is_available) {
                    categories[item.category].push(item);
                }
            });
            
            // 渲染每个分类
            for (const category in categories) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                categoryDiv.innerHTML = `<h3>${category}</h3>`;
                
                categories[category].forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'menu-item';
                    itemDiv.innerHTML = `
                        <div>
                            <h3>${item.name}</h3>
                            <p>${item.description}</p>
                            <p>¥${item.price.toFixed(2)}</p>
                        </div>
                        <div class="quantity-control">
                            <button class="add-to-order" onclick="addToOrder(${item.id})">加入订单</button>
                        </div>
                    `;
                    categoryDiv.appendChild(itemDiv);
                });
                
                menuContainer.appendChild(categoryDiv);
            }
        }

        // 添加到订单
        function addToOrder(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            
            const existingItem = orderItems.find(i => i.menu_item_id === itemId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                orderItems.push({
                    menu_item_id: item.id,
                    quantity: 1,
                    price: item.price,
                    name: item.name
                });
            }
            
            updateOrder();
        }

        // 从订单中移除
        function removeFromOrder(itemId) {
            orderItems = orderItems.filter(i => i.menu_item_id !== itemId);
            updateOrder();
        }

        // 更新订单显示
        function updateOrder() {
            const orderItemsDiv = document.getElementById('order-items');
            const orderTotalDiv = document.getElementById('order-total');
            
            if (orderItems.length === 0) {
                orderItemsDiv.innerHTML = '<p>您的订单为空</p>';
                orderTotalDiv.innerHTML = '';
                return;
            }
            
            orderItemsDiv.innerHTML = '';
            let total = 0;
            
            orderItems.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'order-item';
                itemDiv.innerHTML = `
                    <span>${item.name} x ${item.quantity}</span>
                    <span>¥${itemTotal.toFixed(2)} <span class="remove-item" onclick="removeFromOrder(${item.menu_item_id})">×</span></span>
                `;
                orderItemsDiv.appendChild(itemDiv);
            });
            
            orderTotalDiv.innerHTML = `<h3>总计: ¥${total.toFixed(2)}</h3>`;
        }

        // 提交订单
        function submitOrder() {
            if (orderItems.length === 0) {
                showModal('提示', '您的订单为空，无法提交');
                return;
            }
            
            const orderData = {
                table_number: tableNumber,
                items: orderItems
            };
            
            fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                currentOrderId = data.id;
                showModal('订单提交成功', `您的订单号是: ${data.id}`);
                
                // 清空订单
                orderItems = [];
                updateOrder();
                
                // 开始轮询订单状态
                startStatusCheck();
            })
            .catch(error => {
                console.error('提交订单失败:', error);
                showModal('错误', '提交订单失败，请重试');
            });
        }

        // 开始轮询订单状态
        function startStatusCheck() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            statusCheckInterval = setInterval(() => {
                fetch(`/api/orders?id=${currentOrderId}`)
                    .then(response => response.json())
                    .then(data => {
                        const statusElement = document.getElementById('order-status');
                        let statusText = '';
                        
                        switch(data.status) {
                            case 'pending':
                                statusText = '订单已提交，等待处理';
                                break;
                            case 'preparing':
                                statusText = '您的餐点正在制作中';
                                break;
                            case 'ready':
                                statusText = '🎉 您的餐点已就绪，请享用！';
                                // 订单已完成，停止轮询
                                clearInterval(statusCheckInterval);
                                break;
                            case 'completed':
                                statusText = '订单已完成';
                                clearInterval(statusCheckInterval);
                                break;
                            case 'cancelled':
                                statusText = '订单已取消';
                                clearInterval(statusCheckInterval);
                                break;
                            default:
                                statusText = '未知状态';
                        }
                        
                        statusElement.textContent = `订单状态: ${statusText}`;
                    })
                    .catch(error => {
                        console.error('获取订单状态失败:', error);
                    });
            }, 3000); // 每3秒查询一次
        }

        // 显示模态框
        function showModal(title, message) {
            const modal = document.getElementById('order-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            modal.style.display = 'flex';
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('order-modal').style.display = 'none';
        }

        // 页面加载完成后初始化
        window.onload = init;
    </script>
</body>
</html>