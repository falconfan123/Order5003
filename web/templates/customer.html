<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚¹é¤ç³»ç»Ÿ - é¡¾å®¢ç«¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .menu-section {
            flex: 2;
            min-width: 300px;
        }
        .order-section {
            flex: 1;
            min-width: 300px;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 5px;
        }
        .menu-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .menu-item h3 {
            margin: 0;
        }
        .category {
            margin-top: 30px;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .quantity-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: 50%;
        }
        .add-to-order {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 3px;
        }
        .submit-order {
            width: 100%;
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 15px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .remove-item {
            color: #f44336;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 5px;
            max-width: 500px;
            width: 100%;
        }
        .close-btn {
            float: right;
            font-size: 20px;
            cursor: pointer;
        }
        #order-status {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>ç‚¹é¤ç³»ç»Ÿ</h1>
    <div class="container">
        <div class="menu-section">
            <h2>èœå•</h2>
            <div id="menu-container"></div>
        </div>
        <div class="order-section">
            <h2>æ‚¨çš„è®¢å•</h2>
            <div id="order-items"></div>
            <div id="order-total"></div>
            <button class="submit-order" onclick="submitOrder()">æäº¤è®¢å•</button>
            
            <div id="order-status"></div>
        </div>
    </div>
    
    <div class="modal" id="order-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modal-title">è®¢å•ä¿¡æ¯</h2>
            <p id="modal-message"></p>
            <button onclick="closeModal()">ç¡®å®š</button>
        </div>
    </div>

    <script>
        let menuItems = [];
        let orderItems = [];
        let tableNumber = '';
        let currentOrderId = null;
        let statusCheckInterval = null;

        // åˆå§‹åŒ–
        function init() {
            // è·å–æ¡Œå·
            fetch('/api/table/number')
                .then(response => response.json())
                .then(data => {
                    tableNumber = data.table_number;
                    document.querySelector('h1').textContent = `ç‚¹é¤ç³»ç»Ÿ - æ¡Œå·: ${tableNumber}`;
                })
                .catch(error => console.error('è·å–æ¡Œå·å¤±è´¥:', error));
                
            // è·å–èœå•
            fetch('/api/menu')
                .then(response => response.json())
                .then(data => {
                    menuItems = data;
                    renderMenu();
                })
                .catch(error => console.error('è·å–èœå•å¤±è´¥:', error));
        }

        // æ¸²æŸ“èœå•
        function renderMenu() {
            const menuContainer = document.getElementById('menu-container');
            menuContainer.innerHTML = '';
            
            // æŒ‰åˆ†ç±»åˆ†ç»„èœå•
            const categories = {};
            menuItems.forEach(item => {
                if (!categories[item.category]) {
                    categories[item.category] = [];
                }
                if (item.is_available) {
                    categories[item.category].push(item);
                }
            });
            
            // æ¸²æŸ“æ¯ä¸ªåˆ†ç±»
            for (const category in categories) {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                categoryDiv.innerHTML = `<h3>${category}</h3>`;
                
                categories[category].forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'menu-item';
                    itemDiv.innerHTML = `
                        <div>
                            <h3>${item.name}</h3>
                            <p>${item.description}</p>
                            <p>Â¥${item.price.toFixed(2)}</p>
                        </div>
                        <div class="quantity-control">
                            <button class="add-to-order" onclick="addToOrder(${item.id})">åŠ å…¥è®¢å•</button>
                        </div>
                    `;
                    categoryDiv.appendChild(itemDiv);
                });
                
                menuContainer.appendChild(categoryDiv);
            }
        }

        // æ·»åŠ åˆ°è®¢å•
        function addToOrder(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (!item) return;
            
            const existingItem = orderItems.find(i => i.menu_item_id === itemId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                orderItems.push({
                    menu_item_id: item.id,
                    quantity: 1,
                    price: item.price,
                    name: item.name
                });
            }
            
            updateOrder();
        }

        // ä»è®¢å•ä¸­ç§»é™¤
        function removeFromOrder(itemId) {
            orderItems = orderItems.filter(i => i.menu_item_id !== itemId);
            updateOrder();
        }

        // æ›´æ–°è®¢å•æ˜¾ç¤º
        function updateOrder() {
            const orderItemsDiv = document.getElementById('order-items');
            const orderTotalDiv = document.getElementById('order-total');
            
            if (orderItems.length === 0) {
                orderItemsDiv.innerHTML = '<p>æ‚¨çš„è®¢å•ä¸ºç©º</p>';
                orderTotalDiv.innerHTML = '';
                return;
            }
            
            orderItemsDiv.innerHTML = '';
            let total = 0;
            
            orderItems.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'order-item';
                itemDiv.innerHTML = `
                    <span>${item.name} x ${item.quantity}</span>
                    <span>Â¥${itemTotal.toFixed(2)} <span class="remove-item" onclick="removeFromOrder(${item.menu_item_id})">Ã—</span></span>
                `;
                orderItemsDiv.appendChild(itemDiv);
            });
            
            orderTotalDiv.innerHTML = `<h3>æ€»è®¡: Â¥${total.toFixed(2)}</h3>`;
        }

        // æäº¤è®¢å•
        function submitOrder() {
            if (orderItems.length === 0) {
                showModal('æç¤º', 'æ‚¨çš„è®¢å•ä¸ºç©ºï¼Œæ— æ³•æäº¤');
                return;
            }
            
            const orderData = {
                table_number: tableNumber,
                items: orderItems
            };
            
            fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                currentOrderId = data.id;
                showModal('è®¢å•æäº¤æˆåŠŸ', `æ‚¨çš„è®¢å•å·æ˜¯: ${data.id}`);
                
                // æ¸…ç©ºè®¢å•
                orderItems = [];
                updateOrder();
                
                // å¼€å§‹è½®è¯¢è®¢å•çŠ¶æ€
                startStatusCheck();
            })
            .catch(error => {
                console.error('æäº¤è®¢å•å¤±è´¥:', error);
                showModal('é”™è¯¯', 'æäº¤è®¢å•å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        // å¼€å§‹è½®è¯¢è®¢å•çŠ¶æ€
        function startStatusCheck() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            statusCheckInterval = setInterval(() => {
                fetch(`/api/orders?id=${currentOrderId}`)
                    .then(response => response.json())
                    .then(data => {
                        const statusElement = document.getElementById('order-status');
                        let statusText = '';
                        
                        switch(data.status) {
                            case 'pending':
                                statusText = 'è®¢å•å·²æäº¤ï¼Œç­‰å¾…å¤„ç†';
                                break;
                            case 'preparing':
                                statusText = 'æ‚¨çš„é¤ç‚¹æ­£åœ¨åˆ¶ä½œä¸­';
                                break;
                            case 'ready':
                                statusText = 'ğŸ‰ æ‚¨çš„é¤ç‚¹å·²å°±ç»ªï¼Œè¯·äº«ç”¨ï¼';
                                // è®¢å•å·²å®Œæˆï¼Œåœæ­¢è½®è¯¢
                                clearInterval(statusCheckInterval);
                                break;
                            case 'completed':
                                statusText = 'è®¢å•å·²å®Œæˆ';
                                clearInterval(statusCheckInterval);
                                break;
                            case 'cancelled':
                                statusText = 'è®¢å•å·²å–æ¶ˆ';
                                clearInterval(statusCheckInterval);
                                break;
                            default:
                                statusText = 'æœªçŸ¥çŠ¶æ€';
                        }
                        
                        statusElement.textContent = `è®¢å•çŠ¶æ€: ${statusText}`;
                    })
                    .catch(error => {
                        console.error('è·å–è®¢å•çŠ¶æ€å¤±è´¥:', error);
                    });
            }, 3000); // æ¯3ç§’æŸ¥è¯¢ä¸€æ¬¡
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(title, message) {
            const modal = document.getElementById('order-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            modal.style.display = 'flex';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('order-modal').style.display = 'none';
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = init;
    </script>
</body>
</html>