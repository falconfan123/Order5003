<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>点餐系统 - 商家端</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .sidebar {
            flex: 1;
            min-width: 200px;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 5px;
        }
        .content {
            flex: 3;
            min-width: 300px;
        }
        .tab {
            padding: 10px 20px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 1px solid #ddd;
            border-radius: 3px;
            background-color: #f0f0f0;
        }
        .tab.active {
            background-color: #2196F3;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .tab-content.active {
            display: block;
        }
        .order-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .order-details {
            margin-left: 20px;
        }
        .status-select {
            padding: 5px;
        }
        .menu-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        .edit-btn {
            background-color: #FFC107;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
        }
        .delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
        }
        .add-menu-item {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 3px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        .submit-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 3px;
        }
        .login-form {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #logout-btn {
            margin-top: 20px;
            padding: 10px;
            width: 100%;
            background-color: #f44336;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="login-container" class="login-form">
        <h2>商家登录</h2>
        <div class="form-group">
            <label for="username">用户名</label>
            <input type="text" id="username" placeholder="请输入用户名">
        </div>
        <div class="form-group">
            <label for="password">密码</label>
            <input type="password" id="password" placeholder="请输入密码">
        </div>
        <button class="submit-btn" onclick="login()">登录</button>
    </div>

    <div id="app-container" style="display: none;">
        <h1>点餐系统 - 商家管理后台</h1>
        <div class="container">
            <div class="sidebar">
                <div class="tab active" onclick="switchTab('orders')">订单管理</div>
                <div class="tab" onclick="switchTab('menu')">菜单管理</div>
                <div class="tab" onclick="switchTab('revenue')">营收统计</div>
                <button id="logout-btn" onclick="logout()">退出登录</button>
            </div>
            <div class="content">
                <div id="orders-tab" class="tab-content active">
                    <h2>订单管理</h2>
                    <div id="orders-container"></div>
                </div>
                <div id="menu-tab" class="tab-content">
                    <h2>菜单管理</h2>
                    <button class="add-menu-item" onclick="showAddMenuItemForm()">添加菜品</button>
                    <div id="menu-container"></div>
                </div>
                <div id="revenue-tab" class="tab-content">
                    <h2>营收统计</h2>
                    <div id="revenue-container">
                        <p>本系统暂未实现详细的营收统计功能。</p>
                        <p>基本数据可以在订单管理页面查看。</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="menu-item-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
        <div style="background-color: white; padding: 30px; border-radius: 5px; max-width: 500px; width: 100%;">
            <h2 id="modal-title">添加菜品</h2>
            <form id="menu-item-form">
                <input type="hidden" id="menu-item-id">
                <div class="form-group">
                    <label for="menu-item-name">菜品名称</label>
                    <input type="text" id="menu-item-name" required>
                </div>
                <div class="form-group">
                    <label for="menu-item-description">菜品描述</label>
                    <textarea id="menu-item-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="menu-item-price">价格</label>
                    <input type="number" id="menu-item-price" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="menu-item-category">分类</label>
                    <input type="text" id="menu-item-category" required>
                </div>
                <div class="form-group">
                    <label for="menu-item-available">是否可售</label>
                    <select id="menu-item-available">
                        <option value="true">是</option>
                        <option value="false">否</option>
                    </select>
                </div>
                <button type="submit" class="submit-btn">保存</button>
                <button type="button" onclick="closeMenuItemModal()">取消</button>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let refreshInterval = null;

        // 登录
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            fetch('/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({username, password})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('登录失败');
                }
                return response.json();
            })
            .then(data => {
                currentUser = data;
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                
                // 初始化数据
                loadOrders();
                loadMenu();
                
                // 开始定时刷新订单
                startRefreshInterval();
            })
            .catch(error => {
                alert('用户名或密码错误');
                console.error('登录失败:', error);
            });
        }

        // 退出登录
        function logout() {
            currentUser = null;
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'block';
            
            // 停止定时刷新
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // 切换标签页
        function switchTab(tabName) {
            // 隐藏所有内容
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有标签的active状态
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的内容和标签
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // 加载对应的数据
            if (tabName === 'orders') {
                loadOrders();
            } else if (tabName === 'menu') {
                loadMenu();
            }
        }

        // 加载订单数据
        function loadOrders() {
            fetch('/api/orders/all')
                .then(response => response.json())
                .then(orders => {
                    const ordersContainer = document.getElementById('orders-container');
                    
                    if (orders.length === 0) {
                        ordersContainer.innerHTML = '<p>暂无订单</p>';
                        return;
                    }
                    
                    // 按状态分组订单
                    const pendingOrders = orders.filter(order => order.status === 'pending');
                    const preparingOrders = orders.filter(order => order.status === 'preparing');
                    const readyOrders = orders.filter(order => order.status === 'ready');
                    const completedOrders = orders.filter(order => order.status === 'completed' || order.status === 'cancelled');
                    
                    ordersContainer.innerHTML = '';
                    
                    // 显示待处理订单
                    if (pendingOrders.length > 0) {
                        const pendingSection = document.createElement('div');
                        pendingSection.innerHTML = `<h3>待处理订单</h3>`;
                        pendingOrders.forEach(order => {
                            pendingSection.appendChild(createOrderElement(order));
                        });
                        ordersContainer.appendChild(pendingSection);
                    }
                    
                    // 显示制作中订单
                    if (preparingOrders.length > 0) {
                        const preparingSection = document.createElement('div');
                        preparingSection.innerHTML = `<h3>制作中订单</h3>`;
                        preparingOrders.forEach(order => {
                            preparingSection.appendChild(createOrderElement(order));
                        });
                        ordersContainer.appendChild(preparingSection);
                    }
                    
                    // 显示已就绪订单
                    if (readyOrders.length > 0) {
                        const readySection = document.createElement('div');
                        readySection.innerHTML = `<h3>已就绪订单</h3>`;
                        readyOrders.forEach(order => {
                            readySection.appendChild(createOrderElement(order));
                        });
                        ordersContainer.appendChild(readySection);
                    }
                    
                    // 显示已完成订单
                    if (completedOrders.length > 0) {
                        const completedSection = document.createElement('div');
                        completedSection.innerHTML = `<h3>已完成订单</h3>`;
                        completedOrders.forEach(order => {
                            completedSection.appendChild(createOrderElement(order));
                        });
                        ordersContainer.appendChild(completedSection);
                    }
                })
                .catch(error => {
                    console.error('加载订单失败:', error);
                });
        }

        // 创建订单元素
        function createOrderElement(order) {
            const orderDiv = document.createElement('div');
            orderDiv.className = 'order-item';
            
            let statusText = '';
            switch(order.status) {
                case 'pending': statusText = '待处理'; break;
                case 'preparing': statusText = '制作中'; break;
                case 'ready': statusText = '已就绪'; break;
                case 'completed': statusText = '已完成'; break;
                case 'cancelled': statusText = '已取消'; break;
                default: statusText = '未知';
            }
            
            let statusOptions = '';
            if (order.status === 'pending') {
                statusOptions = `
                    <option value="pending" selected>待处理</option>
                    <option value="preparing">制作中</option>
                    <option value="cancelled">已取消</option>
                `;
            } else if (order.status === 'preparing') {
                statusOptions = `
                    <option value="pending">待处理</option>
                    <option value="preparing" selected>制作中</option>
                    <option value="ready">已就绪</option>
                    <option value="cancelled">已取消</option>
                `;
            } else if (order.status === 'ready') {
                statusOptions = `
                    <option value="pending">待处理</option>
                    <option value="preparing">制作中</option>
                    <option value="ready" selected>已就绪</option>
                    <option value="completed">已完成</option>
                    <option value="cancelled">已取消</option>
                `;
            } else {
                statusOptions = `
                    <option value="${order.status}" selected>${statusText}</option>
                `;
            }
            
            orderDiv.innerHTML = `
                <div class="order-header">
                    <div>
                        <strong>订单号: ${order.id}</strong>
                        <p>桌号: ${order.table_number}</p>
                        <p>创建时间: ${new Date(order.created_at).toLocaleString()}</p>
                    </div>
                    <div>
                        <select class="status-select" onchange="updateOrderStatus(${order.id}, this.value)">
                            ${statusOptions}
                        </select>
                    </div>
                </div>
                <div class="order-details">
                    ${order.items.map(item => `
                        <p>${item.name} x ${item.quantity} - ¥${item.price.toFixed(2)}</p>
                    `).join('')}
                    <p><strong>总计: ¥${order.total.toFixed(2)}</strong></p>
                </div>
            `;
            
            return orderDiv;
        }

        // 更新订单状态
        function updateOrderStatus(orderId, status) {
            fetch(`/api/orders/status?id=${orderId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({status})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('更新状态失败');
                }
                // 刷新订单列表
                loadOrders();
            })
            .catch(error => {
                console.error('更新订单状态失败:', error);
                alert('更新订单状态失败，请重试');
                // 刷新订单列表以恢复原状态
                loadOrders();
            });
        }

        // 加载菜单数据
        function loadMenu() {
            fetch('/api/menu')
                .then(response => response.json())
                .then(menuItems => {
                    const menuContainer = document.getElementById('menu-container');
                    
                    if (menuItems.length === 0) {
                        menuContainer.innerHTML = '<p>暂无菜品</p>';
                        return;
                    }
                    
                    // 按分类分组菜单
                    const categories = {};
                    menuItems.forEach(item => {
                        if (!categories[item.category]) {
                            categories[item.category] = [];
                        }
                        categories[item.category].push(item);
                    });
                    
                    menuContainer.innerHTML = '';
                    
                    // 渲染每个分类
                    for (const category in categories) {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.innerHTML = `<h3>${category}</h3>`;
                        
                        categories[category].forEach(item => {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'menu-item';
                            
                            let availability = '可售';
                            if (!item.is_available) {
                                availability = '不可售';
                            }
                            
                            itemDiv.innerHTML = `
                                <div>
                                    <h4>${item.name}</h4>
                                    <p>${item.description}</p>
                                    <p>¥${item.price.toFixed(2)} - ${availability}</p>
                                </div>
                                <div class="action-buttons">
                                    <button class="edit-btn" onclick="editMenuItem(${item.id})">编辑</button>
                                    <button class="delete-btn" onclick="deleteMenuItem(${item.id})">删除</button>
                                </div>
                            `;
                            
                            categoryDiv.appendChild(itemDiv);
                        });
                        
                        menuContainer.appendChild(categoryDiv);
                    }
                })
                .catch(error => {
                    console.error('加载菜单失败:', error);
                });
        }

        // 显示添加菜品表单
        function showAddMenuItemForm() {
            document.getElementById('modal-title').textContent = '添加菜品';
            document.getElementById('menu-item-form').reset();
            document.getElementById('menu-item-id').value = '';
            document.getElementById('menu-item-modal').style.display = 'flex';
        }

        // 编辑菜品
        function editMenuItem(id) {
            fetch(`/api/menu-item?id=${id}`)
                .then(response => response.json())
                .then(item => {
                    document.getElementById('modal-title').textContent = '编辑菜品';
                    document.getElementById('menu-item-id').value = item.id;
                    document.getElementById('menu-item-name').value = item.name;
                    document.getElementById('menu-item-description').value = item.description || '';
                    document.getElementById('menu-item-price').value = item.price;
                    document.getElementById('menu-item-category').value = item.category;
                    document.getElementById('menu-item-available').value = item.is_available ? 'true' : 'false';
                    document.getElementById('menu-item-modal').style.display = 'flex';
                })
                .catch(error => {
                    console.error('获取菜品信息失败:', error);
                    alert('获取菜品信息失败，请重试');
                });
        }

        // 关闭菜品编辑模态框
        function closeMenuItemModal() {
            document.getElementById('menu-item-modal').style.display = 'none';
        }

        // 删除菜品
        function deleteMenuItem(id) {
            if (confirm('确定要删除这个菜品吗？')) {
                fetch(`/api/menu-item?id=${id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('删除失败');
                    }
                    // 刷新菜单列表
                    loadMenu();
                })
                .catch(error => {
                    console.error('删除菜品失败:', error);
                    alert('删除菜品失败，请重试');
                });
            }
        }

        // 提交菜品表单
        document.getElementById('menu-item-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('menu-item-id').value;
            const name = document.getElementById('menu-item-name').value;
            const description = document.getElementById('menu-item-description').value;
            const price = parseFloat(document.getElementById('menu-item-price').value);
            const category = document.getElementById('menu-item-category').value;
            const isAvailable = document.getElementById('menu-item-available').value === 'true';
            
            const menuItem = {
                name,
                description,
                price,
                category,
                is_available: isAvailable
            };
            
            let url = '/api/menu-item';
            let method = 'POST';
            
            if (id) {
                url = `/api/menu-item?id=${id}`;
                method = 'PUT';
            }
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(menuItem)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('保存失败');
                }
                closeMenuItemModal();
                loadMenu();
            })
            .catch(error => {
                console.error('保存菜品失败:', error);
                alert('保存菜品失败，请重试');
            });
        });

        // 开始定时刷新订单
        function startRefreshInterval() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(() => {
                // 只有在订单标签页时才刷新
                if (document.getElementById('orders-tab').classList.contains('active')) {
                    loadOrders();
                }
            }, 5000); // 每5秒刷新一次
        }
    </script>
</body>
</html>